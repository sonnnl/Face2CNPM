{"ast":null,"code":"import React,{useEffect,useRef,useState}from\"react\";import{Box,Typography,Button,Alert,Paper,Grid,CircularProgress}from\"@mui/material\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const CameraTestPage=()=>{const videoRef=useRef(null);const canvasRef=useRef(null);const[error,setError]=useState(null);const[isCameraReady,setIsCameraReady]=useState(false);const[isSupported,setIsSupported]=useState(true);const[permissionState,setPermissionState]=useState(\"chưa kiểm tra\");const[cameraStream,setCameraStream]=useState(null);const[mediaDevices,setMediaDevices]=useState([]);const[isLoading,setIsLoading]=useState(false);const[capturedImage,setCapturedImage]=useState(null);// Kiểm tra hỗ trợ\nuseEffect(()=>{console.log(\"CameraTestPage mounted\");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){console.error(\"MediaDevices API không được hỗ trợ\");setIsSupported(false);setError(\"Trình duyệt không hỗ trợ API camera\");}else{console.log(\"MediaDevices API được hỗ trợ\");}// Liệt kê các thiết bị media\nif(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){navigator.mediaDevices.enumerateDevices().then(devices=>{const videoDevices=devices.filter(device=>device.kind===\"videoinput\");console.log(\"Danh sách thiết bị camera:\",videoDevices);setMediaDevices(videoDevices);}).catch(err=>{console.error(\"Lỗi khi liệt kê thiết bị:\",err);});}return()=>{// Cleanup\nif(cameraStream){cameraStream.getTracks().forEach(track=>{track.stop();});}};},[]);// Kiểm tra quyền camera\nconst checkCameraPermission=async()=>{try{const result=await navigator.permissions.query({name:\"camera\"});console.log(\"Trạng thái quyền camera:\",result.state);setPermissionState(result.state);// Lắng nghe sự thay đổi trạng thái\nresult.onchange=()=>{console.log(\"Quyền camera đã thay đổi:\",result.state);setPermissionState(result.state);};}catch(err){console.log(\"Không thể truy vấn quyền camera:\",err);}};// Khởi tạo camera\nconst startCamera=async()=>{try{setError(null);setIsLoading(true);console.log(\"Đang yêu cầu stream camera...\");const constraints={video:{width:{ideal:640},height:{ideal:480},facingMode:\"user\"},audio:false};console.log(\"Constraints yêu cầu:\",JSON.stringify(constraints));const stream=await navigator.mediaDevices.getUserMedia(constraints);console.log(\"Đã nhận được stream camera:\",stream.id);console.log(\"Stream tracks:\",stream.getTracks().map(t=>({id:t.id,kind:t.kind,label:t.label})));setCameraStream(stream);if(videoRef.current){// Thử cách 1: Set srcObject\nvideoRef.current.srcObject=stream;// Thêm event listeners cho video element\nvideoRef.current.onloadedmetadata=()=>{console.log(\"Video metadata đã được load\");};videoRef.current.onloadeddata=()=>{console.log(\"Video data đã được load\");};videoRef.current.onplay=()=>{console.log(\"Video đã bắt đầu phát\");};videoRef.current.onerror=e=>{console.error(\"Lỗi video element:\",e);};try{console.log(\"Đang cố gắng phát video...\");await videoRef.current.play();console.log(\"Video.play() thành công\");}catch(playErr){console.error(\"Lỗi khi phát video:\",playErr);}setIsCameraReady(true);await checkCameraPermission();}else{console.error(\"videoRef.current không tồn tại\");}}catch(err){console.error(\"Lỗi khi truy cập camera:\",err);setError(`Lỗi: ${err.name} - ${err.message}`);setIsCameraReady(false);await checkCameraPermission();}finally{setIsLoading(false);}};// Chụp ảnh từ camera\nconst captureImage=()=>{if(videoRef.current&&isCameraReady){const canvas=document.createElement(\"canvas\");canvas.width=videoRef.current.videoWidth;canvas.height=videoRef.current.videoHeight;const ctx=canvas.getContext(\"2d\");// Vẽ video frame hiện tại vào canvas\nctx.drawImage(videoRef.current,0,0,canvas.width,canvas.height);// Chuyển đổi canvas thành data URL\nconst dataUrl=canvas.toDataURL(\"image/jpeg\");console.log(\"Đã chụp ảnh, kích thước:\",canvas.width,\"x\",canvas.height);setCapturedImage(dataUrl);}};// Dừng camera\nconst stopCamera=()=>{if(cameraStream){cameraStream.getTracks().forEach(track=>{console.log(\"Dừng track camera:\",track.id);track.stop();});setCameraStream(null);}if(videoRef.current){videoRef.current.srcObject=null;}setIsCameraReady(false);setCapturedImage(null);};// Kiểm tra hỗ trợ\nconst getBrowserInfo=()=>{const userAgent=navigator.userAgent;const browserInfo={userAgent,isChrome:userAgent.indexOf(\"Chrome\")>-1,isFirefox:userAgent.indexOf(\"Firefox\")>-1,isSafari:userAgent.indexOf(\"Safari\")>-1&&userAgent.indexOf(\"Chrome\")===-1,isEdge:userAgent.indexOf(\"Edg\")>-1,hasMediaDevices:!!navigator.mediaDevices,hasGetUserMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)};return browserInfo;};const browserInfo=getBrowserInfo();// Thử cách khác để bật camera\nconst tryAlternativeCamera=async()=>{try{setError(null);setIsLoading(true);// Tạo một video element mới\nconst testVideo=document.createElement(\"video\");testVideo.autoplay=true;testVideo.muted=true;testVideo.playsInline=true;// Yêu cầu stream với các thiết lập tối thiểu\nconst minimalStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});console.log(\"Đã nhận được stream camera tối thiểu\");setCameraStream(minimalStream);// Gắn stream vào video element\ntestVideo.srcObject=minimalStream;// Chờ video element sẵn sàng\nawait new Promise(resolve=>{testVideo.onloadedmetadata=()=>{testVideo.play().then(resolve).catch(e=>{console.error(\"Lỗi khi phát video tối thiểu:\",e);resolve();});};});// Gắn stream vào video element trong DOM\nif(videoRef.current){videoRef.current.srcObject=minimalStream;setIsCameraReady(true);}console.log(\"Thử cách thay thế thành công\");}catch(err){console.error(\"Lỗi khi thử cách thay thế:\",err);setError(`Lỗi cách thay thế: ${err.name} - ${err.message}`);}finally{setIsLoading(false);}};return/*#__PURE__*/_jsxs(Box,{sx:{p:4,maxWidth:800,mx:\"auto\"},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",gutterBottom:true,children:\"Ki\\u1EC3m Tra Camera\"}),/*#__PURE__*/_jsxs(Paper,{sx:{p:2,mb:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Th\\xF4ng tin tr\\xECnh duy\\u1EC7t:\"}),/*#__PURE__*/_jsx(\"pre\",{style:{overflowX:\"auto\",backgroundColor:\"#f5f5f5\",p:2},children:JSON.stringify(browserInfo,null,2)}),/*#__PURE__*/_jsxs(Typography,{children:[\"Tr\\u1EA1ng th\\xE1i quy\\u1EC1n camera: \",/*#__PURE__*/_jsx(\"strong\",{children:permissionState})]}),mediaDevices.length>0&&/*#__PURE__*/_jsxs(Box,{mt:2,children:[/*#__PURE__*/_jsxs(Typography,{variant:\"h6\",gutterBottom:true,children:[\"Thi\\u1EBFt b\\u1ECB camera ph\\xE1t hi\\u1EC7n (\",mediaDevices.length,\"):\"]}),/*#__PURE__*/_jsx(\"ul\",{children:mediaDevices.map((device,index)=>/*#__PURE__*/_jsxs(\"li\",{children:[device.label||`Camera ${index+1}`,\" (ID:\",\" \",device.deviceId.substring(0,8),\"...)\"]},device.deviceId))})]})]}),/*#__PURE__*/_jsxs(Box,{sx:{mb:3},children:[/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:startCamera,disabled:!isSupported||isCameraReady||isLoading,sx:{mr:2},children:isLoading?/*#__PURE__*/_jsx(CircularProgress,{size:24}):\"Bật Camera\"}),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"secondary\",onClick:tryAlternativeCamera,disabled:!isSupported||isCameraReady||isLoading,sx:{mr:2},children:\"Th\\u1EED C\\xE1ch Kh\\xE1c\"}),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"error\",onClick:stopCamera,disabled:!isCameraReady||isLoading,children:\"T\\u1EAFt Camera\"}),isCameraReady&&/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"info\",onClick:captureImage,sx:{ml:2},children:\"Ch\\u1EE5p \\u1EA3nh\"})]}),error&&/*#__PURE__*/_jsx(Alert,{severity:\"error\",sx:{mb:3},children:error}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:capturedImage?6:12,children:/*#__PURE__*/_jsx(Paper,{elevation:3,sx:{width:\"100%\",height:\"400px\",display:\"flex\",justifyContent:\"center\",alignItems:\"center\",backgroundColor:\"#f0f0f0\",overflow:\"hidden\",position:\"relative\"},children:isCameraReady?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"video\",{ref:videoRef,autoPlay:true,playsInline:true,muted:true,style:{width:\"100%\",height:\"100%\",objectFit:\"cover\"}}),/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef,style:{display:\"none\",position:\"absolute\",top:0,left:0}}),isLoading&&/*#__PURE__*/_jsx(Box,{sx:{position:\"absolute\",top:0,left:0,right:0,bottom:0,display:\"flex\",alignItems:\"center\",justifyContent:\"center\",backgroundColor:\"rgba(0,0,0,0.3)\"},children:/*#__PURE__*/_jsx(CircularProgress,{})})]}):/*#__PURE__*/_jsx(Typography,{variant:\"body1\",align:\"center\",children:isLoading?/*#__PURE__*/_jsxs(Box,{display:\"flex\",flexDirection:\"column\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(CircularProgress,{sx:{mb:2}}),/*#__PURE__*/_jsx(Typography,{children:\"\\u0110ang kh\\u1EDFi t\\u1EA1o camera...\"})]}):isSupported?\"Nhấn 'Bật Camera' để bắt đầu\":\"Trình duyệt không hỗ trợ camera\"})})}),capturedImage&&/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(Paper,{elevation:3,sx:{width:\"100%\",height:\"400px\",display:\"flex\",justifyContent:\"center\",alignItems:\"center\",backgroundColor:\"#f0f0f0\",overflow:\"hidden\"},children:/*#__PURE__*/_jsx(\"img\",{src:capturedImage,alt:\"\\u1EA2nh ch\\u1EE5p t\\u1EEB camera\",style:{maxWidth:\"100%\",maxHeight:\"100%\"}})})})]}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{mt:2,color:\"text.secondary\"},children:\"* N\\u1EBFu camera kh\\xF4ng ho\\u1EA1t \\u0111\\u1ED9ng, h\\xE3y ki\\u1EC3m tra c\\xE0i \\u0111\\u1EB7t quy\\u1EC1n trong tr\\xECnh duy\\u1EC7t v\\xE0 \\u0111\\u1EA3m b\\u1EA3o kh\\xF4ng c\\xF3 \\u1EE9ng d\\u1EE5ng n\\xE0o kh\\xE1c \\u0111ang s\\u1EED d\\u1EE5ng camera.\"}),/*#__PURE__*/_jsxs(Paper,{sx:{p:2,mt:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"L\\u1ED7i th\\u01B0\\u1EDDng g\\u1EB7p v\\xE0 c\\xE1ch kh\\u1EAFc ph\\u1EE5c:\"}),/*#__PURE__*/_jsxs(\"ul\",{children:[/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"NotAllowedError:\"}),\" B\\u1EA1n c\\u1EA7n c\\u1EA5p quy\\u1EC1n truy c\\u1EADp camera trong tr\\xECnh duy\\u1EC7t\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"NotReadableError/TrackStartError:\"}),\" Camera \\u0111ang \\u0111\\u01B0\\u1EE3c s\\u1EED d\\u1EE5ng b\\u1EDFi \\u1EE9ng d\\u1EE5ng kh\\xE1c\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"OverconstrainedError:\"}),\" Kh\\xF4ng c\\xF3 camera n\\xE0o \\u0111\\xE1p \\u1EE9ng y\\xEAu c\\u1EA7u (th\\u1EED v\\u1EDBi c\\xE0i \\u0111\\u1EB7t \\u0111\\u01A1n gi\\u1EA3n h\\u01A1n)\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Kh\\xF4ng th\\u1EA5y feed video:\"}),\" Th\\u1EED l\\xE0m m\\u1EDBi trang, t\\u1EAFt c\\xE1c ph\\u1EA7n m\\u1EDF r\\u1ED9ng c\\u1EE7a tr\\xECnh duy\\u1EC7t, ho\\u1EB7c s\\u1EED d\\u1EE5ng tr\\xECnh duy\\u1EC7t kh\\xE1c\"]})]})]})]});};export default CameraTestPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}