{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\kasiz\\\\Documents\\\\Studying\\\\FaceReg\\\\frontend\\\\src\\\\components\\\\FaceRegistrationComponent.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef, lazy, Suspense } from \"react\";\nimport { useSnackbar } from \"notistack\";\nimport { Box, Typography, Button, CircularProgress, Alert, Stack, Avatar, Paper, FormControlLabel, Switch } from \"@mui/material\";\nimport { CameraAlt, CheckCircleOutline, ErrorOutline, Person, Replay, Visibility, VisibilityOff } from \"@mui/icons-material\";\nimport { loadModels, detectFace } from \"../utils/faceUtils\";\nimport * as faceapi from \"face-api.js\";\n\n// Lazy load Webcam\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst Webcam = /*#__PURE__*/lazy(_c = () => import(\"react-webcam\"));\n\n// Consistent video constraints\n_c2 = Webcam;\nconst videoConstraints = {\n  width: {\n    ideal: 480\n  },\n  height: {\n    ideal: 360\n  },\n  facingMode: \"user\"\n};\nconst FaceRegistrationComponent = ({\n  onFaceDataCapture,\n  requiredImages = 3\n}) => {\n  _s();\n  // Refs\n  const webcamRef = useRef(null);\n  const canvasRef = useRef(null);\n\n  // State\n  const [modelsLoaded, setModelsLoaded] = useState(false);\n  const [modelLoadingError, setModelLoadingError] = useState(null);\n  const [cameraReady, setCameraReady] = useState(false);\n  const [cameraError, setCameraError] = useState(null);\n  const [capturedImages, setCapturedImages] = useState([]);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [captureError, setCaptureError] = useState(\"\");\n  const [showLandmarks, setShowLandmarks] = useState(true);\n  const {\n    enqueueSnackbar\n  } = useSnackbar();\n\n  // 1. Load face recognition models on mount\n  useEffect(() => {\n    const initModels = async () => {\n      setModelLoadingError(null); // Reset error\n      try {\n        await loadModels();\n        setModelsLoaded(true);\n      } catch (err) {\n        console.error(\"[FaceComponent] Error loading models:\", err);\n        setModelLoadingError(\"Không thể tải mô hình nhận diện. Vui lòng thử tải lại trang.\");\n        enqueueSnackbar(\"Lỗi tải mô hình nhận diện\", {\n          variant: \"error\"\n        });\n      }\n    };\n    initModels();\n  }, [enqueueSnackbar]); // Run only once on mount\n\n  // 2. Handle camera state changes\n  const handleUserMedia = () => {\n    setCameraReady(true);\n    setCameraError(null); // Clear previous camera error\n  };\n  const handleUserMediaError = error => {\n    console.error(\"[FaceComponent] Camera error:\", error);\n    setCameraReady(false);\n    const errorMsg = \"Không thể truy cập camera. Vui lòng cấp quyền và thử lại.\";\n    setCameraError(errorMsg);\n    enqueueSnackbar(errorMsg, {\n      variant: \"error\"\n    });\n  };\n\n  // 3. Real-time landmark drawing effect\n  useEffect(() => {\n    let animationFrameId;\n    const runFaceDetection = async () => {\n      if (webcamRef.current && webcamRef.current.video && canvasRef.current && modelsLoaded && cameraReady && showLandmarks && !isProcessing) {\n        const video = webcamRef.current.video;\n        const canvas = canvasRef.current;\n        if (video.readyState < 3) {\n          // Wait until video has enough data\n          return;\n        }\n        const displaySize = {\n          width: video.videoWidth,\n          height: video.videoHeight\n        };\n        if (canvas.width !== displaySize.width || canvas.height !== displaySize.height) {\n          faceapi.matchDimensions(canvas, displaySize);\n        }\n        try {\n          const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();\n          const ctx = canvas.getContext(\"2d\");\n          ctx.clearRect(0, 0, canvas.width, canvas.height);\n          if (detections) {\n            const resizedDetections = faceapi.resizeResults(detections, displaySize);\n            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);\n          } else {\n            ctx.clearRect(0, 0, canvas.width, canvas.height);\n          }\n        } catch (error) {\n          // Don't spam console if detection fails occasionally\n          // console.error(\"Error in real-time detection loop:\", error);\n        }\n      }\n    };\n    const detectionLoop = () => {\n      runFaceDetection().finally(() => {\n        animationFrameId = requestAnimationFrame(detectionLoop);\n      });\n    };\n\n    // Start loop only when everything is ready and landmarks are enabled\n    if (modelsLoaded && cameraReady && showLandmarks && !modelLoadingError && !cameraError) {\n      animationFrameId = requestAnimationFrame(detectionLoop);\n    } else {\n      // Clear canvas if conditions are not met\n      if (canvasRef.current) {\n        const canvas = canvasRef.current;\n        const ctx = canvas.getContext(\"2d\");\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\n      }\n    }\n\n    // Cleanup function\n    return () => {\n      if (animationFrameId) {\n        cancelAnimationFrame(animationFrameId);\n      }\n    };\n  }, [modelsLoaded, cameraReady, showLandmarks, isProcessing, modelLoadingError, cameraError]);\n\n  // 4. Capture and detect face\n  const captureImage = async () => {\n    // Basic checks\n    if (!webcamRef.current || !cameraReady || isProcessing || !modelsLoaded) {\n      let reason = \"Chưa sẵn sàng\";\n      if (!cameraReady) reason = \"Camera chưa sẵn sàng\";else if (isProcessing) reason = \"Đang xử lý\";else if (!modelsLoaded) reason = \"Mô hình chưa tải xong\";\n      enqueueSnackbar(`Không thể chụp ảnh: ${reason}`, {\n        variant: \"warning\"\n      });\n      return;\n    }\n    if (capturedImages.length >= requiredImages) {\n      enqueueSnackbar(`Đã chụp đủ ${requiredImages} ảnh.`, {\n        variant: \"info\"\n      });\n      return;\n    }\n    setIsProcessing(true);\n    setCaptureError(\"\"); // Clear previous capture error\n\n    try {\n      const imageSrc = webcamRef.current.getScreenshot({\n        width: videoConstraints.width.ideal,\n        height: videoConstraints.height.ideal\n      });\n      if (!imageSrc) {\n        throw new Error(\"Không thể chụp ảnh từ webcam.\");\n      }\n\n      // Perform face detection\n      const detections = await detectFace(imageSrc);\n      if (!detections || !detections.descriptor) {\n        console.warn(\"[FaceComponent] Face detection failed or no descriptor found.\");\n        enqueueSnackbar(\"Không phát hiện được khuôn mặt rõ ràng. Hãy thử lại.\", {\n          variant: \"warning\"\n        });\n        setIsProcessing(false); // Allow retry\n        return;\n      }\n\n      // Store image and descriptor\n      const newImageData = {\n        img: imageSrc,\n        descriptor: Array.from(detections.descriptor) // Ensure serializable\n      };\n      const updatedImages = [...capturedImages, newImageData];\n      setCapturedImages(updatedImages);\n      enqueueSnackbar(`Đã chụp ảnh ${updatedImages.length}/${requiredImages}`, {\n        variant: \"success\",\n        autoHideDuration: 1500\n      });\n\n      // If enough images captured, notify parent immediately\n      if (updatedImages.length >= requiredImages) {\n        onFaceDataCapture(updatedImages); // Pass all captured data\n        enqueueSnackbar(`Đã chụp đủ ${requiredImages} ảnh!`, {\n          variant: \"info\"\n        });\n      }\n    } catch (err) {\n      console.error(\"[FaceComponent] Error capturing image:\", err);\n      const errorMsg = \"Lỗi khi chụp ảnh. Vui lòng thử lại.\";\n      setCaptureError(errorMsg);\n      enqueueSnackbar(errorMsg, {\n        variant: \"error\"\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // 5. Reset capture\n  const resetCapture = () => {\n    setCapturedImages([]);\n    setCaptureError(\"\");\n    // Notify parent that data is cleared (optional, depends on parent needs)\n    // onFaceDataCapture(null); or onFaceDataCapture([]);\n    enqueueSnackbar(\"Đã xóa ảnh đã chụp, bạn có thể chụp lại.\", {\n      variant: \"info\"\n    });\n  };\n\n  // --- Render Logic ---\n\n  const renderCameraView = () => /*#__PURE__*/_jsxDEV(Paper, {\n    elevation: 2,\n    sx: {\n      position: \"relative\",\n      width: \"100%\",\n      maxWidth: `${videoConstraints.width.ideal}px`,\n      aspectRatio: `${videoConstraints.width.ideal} / ${videoConstraints.height.ideal}`,\n      margin: \"16px auto\",\n      overflow: \"hidden\",\n      bgcolor: \"grey.200\",\n      border: cameraError ? \"2px solid red\" : \"1px solid\",\n      borderColor: \"divider\"\n    },\n    children: [/*#__PURE__*/_jsxDEV(Suspense, {\n      fallback: /*#__PURE__*/_jsxDEV(Box, {\n        sx: {\n          position: \"absolute\",\n          top: \"50%\",\n          left: \"50%\",\n          transform: \"translate(-50%, -50%)\"\n        },\n        children: /*#__PURE__*/_jsxDEV(CircularProgress, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 296,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 288,\n        columnNumber: 11\n      }, this),\n      children: [/*#__PURE__*/_jsxDEV(Webcam, {\n        audio: false,\n        ref: webcamRef,\n        screenshotFormat: \"image/jpeg\",\n        videoConstraints: videoConstraints,\n        onUserMedia: handleUserMedia,\n        onUserMediaError: handleUserMediaError,\n        style: {\n          display: \"block\",\n          width: \"100%\",\n          height: \"100%\",\n          objectFit: \"cover\"\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 300,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"canvas\", {\n        ref: canvasRef,\n        style: {\n          position: \"absolute\",\n          top: 0,\n          left: 0,\n          width: \"100%\",\n          height: \"100%\",\n          display: showLandmarks ? \"block\" : \"none\"\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 314,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 286,\n      columnNumber: 7\n    }, this), (!modelsLoaded || !cameraReady || cameraError || modelLoadingError) && /*#__PURE__*/_jsxDEV(Box, {\n      sx: {\n        position: \"absolute\",\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n        backgroundColor: \"rgba(0, 0, 0, 0.5)\",\n        display: \"flex\",\n        flexDirection: \"column\",\n        justifyContent: \"center\",\n        alignItems: \"center\",\n        color: \"white\",\n        textAlign: \"center\",\n        p: 2\n      },\n      children: [/*#__PURE__*/_jsxDEV(CircularProgress, {\n        color: \"inherit\",\n        sx: {\n          mb: 2\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 346,\n        columnNumber: 11\n      }, this), modelLoadingError && /*#__PURE__*/_jsxDEV(Typography, {\n        variant: \"body2\",\n        color: \"error\",\n        children: modelLoadingError\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 348,\n        columnNumber: 13\n      }, this), cameraError && /*#__PURE__*/_jsxDEV(Typography, {\n        variant: \"body2\",\n        color: \"error\",\n        children: cameraError\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 353,\n        columnNumber: 13\n      }, this), !modelLoadingError && !cameraError && !modelsLoaded && /*#__PURE__*/_jsxDEV(Typography, {\n        children: \"\\u0110ang t\\u1EA3i m\\xF4 h\\xECnh...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 358,\n        columnNumber: 13\n      }, this), !modelLoadingError && !cameraError && modelsLoaded && !cameraReady && /*#__PURE__*/_jsxDEV(Typography, {\n        children: \"\\u0110ang kh\\u1EDFi \\u0111\\u1ED9ng camera...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 363,\n        columnNumber: 29\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 329,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 272,\n    columnNumber: 5\n  }, this);\n  const renderCaptureControls = () => /*#__PURE__*/_jsxDEV(Box, {\n    sx: {\n      textAlign: \"center\",\n      mt: 2\n    },\n    children: [/*#__PURE__*/_jsxDEV(FormControlLabel, {\n      control: /*#__PURE__*/_jsxDEV(Switch, {\n        checked: showLandmarks,\n        onChange: e => setShowLandmarks(e.target.checked),\n        size: \"small\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 373,\n        columnNumber: 11\n      }, this),\n      label: \"Hi\\u1EC7n Landmark\",\n      sx: {\n        mb: 1,\n        display: \"block\"\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 371,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Button, {\n      variant: \"contained\",\n      color: \"primary\",\n      startIcon: /*#__PURE__*/_jsxDEV(CameraAlt, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 385,\n        columnNumber: 20\n      }, this),\n      onClick: captureImage,\n      disabled: !cameraReady || !modelsLoaded || isProcessing || capturedImages.length >= requiredImages || !!cameraError || !!modelLoadingError,\n      sx: {\n        mb: 1,\n        mr: 1\n      },\n      children: isProcessing ? /*#__PURE__*/_jsxDEV(CircularProgress, {\n        size: 24,\n        color: \"inherit\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 398,\n        columnNumber: 11\n      }, this) : `Chụp ảnh (${capturedImages.length}/${requiredImages})`\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 382,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Button, {\n      variant: \"outlined\",\n      color: \"warning\",\n      startIcon: /*#__PURE__*/_jsxDEV(Replay, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 406,\n        columnNumber: 20\n      }, this),\n      onClick: resetCapture,\n      disabled: capturedImages.length === 0 || isProcessing,\n      sx: {\n        mb: 1\n      },\n      children: \"Ch\\u1EE5p l\\u1EA1i\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 403,\n      columnNumber: 7\n    }, this), captureError && /*#__PURE__*/_jsxDEV(Alert, {\n      severity: \"error\",\n      sx: {\n        mt: 2,\n        textAlign: \"left\"\n      },\n      children: captureError\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 414,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 370,\n    columnNumber: 5\n  }, this);\n  const renderImagePreviews = () => capturedImages.length > 0 && /*#__PURE__*/_jsxDEV(Box, {\n    sx: {\n      mt: 2,\n      textAlign: \"center\"\n    },\n    children: [/*#__PURE__*/_jsxDEV(Typography, {\n      variant: \"caption\",\n      display: \"block\",\n      gutterBottom: true,\n      children: \"\\u1EA2nh \\u0111\\xE3 ch\\u1EE5p:\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 424,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(Stack, {\n      direction: \"row\",\n      spacing: 1,\n      justifyContent: \"center\",\n      flexWrap: \"wrap\",\n      children: [capturedImages.map((imgData, index) => /*#__PURE__*/_jsxDEV(Avatar, {\n        src: imgData.img,\n        sx: {\n          width: 56,\n          height: 56\n        }\n      }, index, false, {\n        fileName: _jsxFileName,\n        lineNumber: 434,\n        columnNumber: 13\n      }, this)), [...Array(Math.max(0, requiredImages - capturedImages.length))].map((_, i) => /*#__PURE__*/_jsxDEV(Avatar, {\n        sx: {\n          width: 56,\n          height: 56,\n          bgcolor: \"grey.300\"\n        },\n        children: /*#__PURE__*/_jsxDEV(Person, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 447,\n          columnNumber: 17\n        }, this)\n      }, `placeholder-${i}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 443,\n        columnNumber: 15\n      }, this))]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 427,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 423,\n    columnNumber: 7\n  }, this);\n\n  // --- Main Component Render ---\n  return /*#__PURE__*/_jsxDEV(Box, {\n    children: [!modelsLoaded && !modelLoadingError && /*#__PURE__*/_jsxDEV(Box, {\n      sx: {\n        display: \"flex\",\n        justifyContent: \"center\",\n        alignItems: \"center\",\n        p: 2\n      },\n      children: [/*#__PURE__*/_jsxDEV(CircularProgress, {\n        size: 20,\n        sx: {\n          mr: 1\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 468,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(Typography, {\n        children: \"\\u0110ang t\\u1EA3i m\\xF4 h\\xECnh nh\\u1EADn di\\u1EC7n...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 469,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 460,\n      columnNumber: 9\n    }, this), modelLoadingError && /*#__PURE__*/_jsxDEV(Alert, {\n      severity: \"error\",\n      sx: {\n        mb: 2\n      },\n      children: modelLoadingError\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 473,\n      columnNumber: 9\n    }, this), modelsLoaded && !modelLoadingError && /*#__PURE__*/_jsxDEV(_Fragment, {\n      children: [renderCameraView(), renderCaptureControls(), renderImagePreviews()]\n    }, void 0, true), capturedImages.length >= requiredImages && /*#__PURE__*/_jsxDEV(Alert, {\n      severity: \"success\",\n      icon: /*#__PURE__*/_jsxDEV(CheckCircleOutline, {\n        fontSize: \"inherit\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 490,\n        columnNumber: 17\n      }, this),\n      sx: {\n        mt: 2\n      },\n      children: [\"\\u0110\\xE3 ch\\u1EE5p \\u0111\\u1EE7 \", requiredImages, \" \\u1EA3nh. B\\u1EA1n c\\xF3 th\\u1EC3 ti\\u1EBFp t\\u1EE5c.\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 488,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 457,\n    columnNumber: 5\n  }, this);\n};\n_s(FaceRegistrationComponent, \"3uskCIHRK/BSnuz29jXeoor2mXg=\", false, function () {\n  return [useSnackbar];\n});\n_c3 = FaceRegistrationComponent;\nexport default FaceRegistrationComponent;\nvar _c, _c2, _c3;\n$RefreshReg$(_c, \"Webcam$lazy\");\n$RefreshReg$(_c2, \"Webcam\");\n$RefreshReg$(_c3, \"FaceRegistrationComponent\");","map":{"version":3,"names":["React","useState","useEffect","useRef","lazy","Suspense","useSnackbar","Box","Typography","Button","CircularProgress","Alert","Stack","Avatar","Paper","FormControlLabel","Switch","CameraAlt","CheckCircleOutline","ErrorOutline","Person","Replay","Visibility","VisibilityOff","loadModels","detectFace","faceapi","jsxDEV","_jsxDEV","Fragment","_Fragment","Webcam","_c","_c2","videoConstraints","width","ideal","height","facingMode","FaceRegistrationComponent","onFaceDataCapture","requiredImages","_s","webcamRef","canvasRef","modelsLoaded","setModelsLoaded","modelLoadingError","setModelLoadingError","cameraReady","setCameraReady","cameraError","setCameraError","capturedImages","setCapturedImages","isProcessing","setIsProcessing","captureError","setCaptureError","showLandmarks","setShowLandmarks","enqueueSnackbar","initModels","err","console","error","variant","handleUserMedia","handleUserMediaError","errorMsg","animationFrameId","runFaceDetection","current","video","canvas","readyState","displaySize","videoWidth","videoHeight","matchDimensions","detections","detectSingleFace","TinyFaceDetectorOptions","withFaceLandmarks","ctx","getContext","clearRect","resizedDetections","resizeResults","draw","drawFaceLandmarks","detectionLoop","finally","requestAnimationFrame","cancelAnimationFrame","captureImage","reason","length","imageSrc","getScreenshot","Error","descriptor","warn","newImageData","img","Array","from","updatedImages","autoHideDuration","resetCapture","renderCameraView","elevation","sx","position","maxWidth","aspectRatio","margin","overflow","bgcolor","border","borderColor","children","fallback","top","left","transform","fileName","_jsxFileName","lineNumber","columnNumber","audio","ref","screenshotFormat","onUserMedia","onUserMediaError","style","display","objectFit","right","bottom","backgroundColor","flexDirection","justifyContent","alignItems","color","textAlign","p","mb","renderCaptureControls","mt","control","checked","onChange","e","target","size","label","startIcon","onClick","disabled","mr","severity","renderImagePreviews","gutterBottom","direction","spacing","flexWrap","map","imgData","index","src","Math","max","_","i","icon","fontSize","_c3","$RefreshReg$"],"sources":["C:/Users/kasiz/Documents/Studying/FaceReg/frontend/src/components/FaceRegistrationComponent.js"],"sourcesContent":["import React, { useState, useEffect, useRef, lazy, Suspense } from \"react\";\r\nimport { useSnackbar } from \"notistack\";\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Button,\r\n  CircularProgress,\r\n  Alert,\r\n  Stack,\r\n  Avatar,\r\n  Paper,\r\n  FormControlLabel,\r\n  Switch,\r\n} from \"@mui/material\";\r\nimport {\r\n  CameraAlt,\r\n  CheckCircleOutline,\r\n  ErrorOutline,\r\n  Person,\r\n  Replay,\r\n  Visibility,\r\n  VisibilityOff,\r\n} from \"@mui/icons-material\";\r\nimport { loadModels, detectFace } from \"../utils/faceUtils\";\r\nimport * as faceapi from \"face-api.js\";\r\n\r\n// Lazy load Webcam\r\nconst Webcam = lazy(() => import(\"react-webcam\"));\r\n\r\n// Consistent video constraints\r\nconst videoConstraints = {\r\n  width: { ideal: 480 },\r\n  height: { ideal: 360 },\r\n  facingMode: \"user\",\r\n};\r\n\r\nconst FaceRegistrationComponent = ({\r\n  onFaceDataCapture,\r\n  requiredImages = 3,\r\n}) => {\r\n  // Refs\r\n  const webcamRef = useRef(null);\r\n  const canvasRef = useRef(null);\r\n\r\n  // State\r\n  const [modelsLoaded, setModelsLoaded] = useState(false);\r\n  const [modelLoadingError, setModelLoadingError] = useState(null);\r\n  const [cameraReady, setCameraReady] = useState(false);\r\n  const [cameraError, setCameraError] = useState(null);\r\n  const [capturedImages, setCapturedImages] = useState([]);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n  const [captureError, setCaptureError] = useState(\"\");\r\n  const [showLandmarks, setShowLandmarks] = useState(true);\r\n  const { enqueueSnackbar } = useSnackbar();\r\n\r\n  // 1. Load face recognition models on mount\r\n  useEffect(() => {\r\n    const initModels = async () => {\r\n      setModelLoadingError(null); // Reset error\r\n      try {\r\n        await loadModels();\r\n        setModelsLoaded(true);\r\n      } catch (err) {\r\n        console.error(\"[FaceComponent] Error loading models:\", err);\r\n        setModelLoadingError(\r\n          \"Không thể tải mô hình nhận diện. Vui lòng thử tải lại trang.\"\r\n        );\r\n        enqueueSnackbar(\"Lỗi tải mô hình nhận diện\", { variant: \"error\" });\r\n      }\r\n    };\r\n    initModels();\r\n  }, [enqueueSnackbar]); // Run only once on mount\r\n\r\n  // 2. Handle camera state changes\r\n  const handleUserMedia = () => {\r\n    setCameraReady(true);\r\n    setCameraError(null); // Clear previous camera error\r\n  };\r\n\r\n  const handleUserMediaError = (error) => {\r\n    console.error(\"[FaceComponent] Camera error:\", error);\r\n    setCameraReady(false);\r\n    const errorMsg =\r\n      \"Không thể truy cập camera. Vui lòng cấp quyền và thử lại.\";\r\n    setCameraError(errorMsg);\r\n    enqueueSnackbar(errorMsg, { variant: \"error\" });\r\n  };\r\n\r\n  // 3. Real-time landmark drawing effect\r\n  useEffect(() => {\r\n    let animationFrameId;\r\n\r\n    const runFaceDetection = async () => {\r\n      if (\r\n        webcamRef.current &&\r\n        webcamRef.current.video &&\r\n        canvasRef.current &&\r\n        modelsLoaded &&\r\n        cameraReady &&\r\n        showLandmarks &&\r\n        !isProcessing\r\n      ) {\r\n        const video = webcamRef.current.video;\r\n        const canvas = canvasRef.current;\r\n\r\n        if (video.readyState < 3) {\r\n          // Wait until video has enough data\r\n          return;\r\n        }\r\n\r\n        const displaySize = {\r\n          width: video.videoWidth,\r\n          height: video.videoHeight,\r\n        };\r\n        if (\r\n          canvas.width !== displaySize.width ||\r\n          canvas.height !== displaySize.height\r\n        ) {\r\n          faceapi.matchDimensions(canvas, displaySize);\r\n        }\r\n\r\n        try {\r\n          const detections = await faceapi\r\n            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())\r\n            .withFaceLandmarks();\r\n\r\n          const ctx = canvas.getContext(\"2d\");\r\n          ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n          if (detections) {\r\n            const resizedDetections = faceapi.resizeResults(\r\n              detections,\r\n              displaySize\r\n            );\r\n            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);\r\n          } else {\r\n            ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n          }\r\n        } catch (error) {\r\n          // Don't spam console if detection fails occasionally\r\n          // console.error(\"Error in real-time detection loop:\", error);\r\n        }\r\n      }\r\n    };\r\n\r\n    const detectionLoop = () => {\r\n      runFaceDetection().finally(() => {\r\n        animationFrameId = requestAnimationFrame(detectionLoop);\r\n      });\r\n    };\r\n\r\n    // Start loop only when everything is ready and landmarks are enabled\r\n    if (\r\n      modelsLoaded &&\r\n      cameraReady &&\r\n      showLandmarks &&\r\n      !modelLoadingError &&\r\n      !cameraError\r\n    ) {\r\n      animationFrameId = requestAnimationFrame(detectionLoop);\r\n    } else {\r\n      // Clear canvas if conditions are not met\r\n      if (canvasRef.current) {\r\n        const canvas = canvasRef.current;\r\n        const ctx = canvas.getContext(\"2d\");\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n      }\r\n    }\r\n\r\n    // Cleanup function\r\n    return () => {\r\n      if (animationFrameId) {\r\n        cancelAnimationFrame(animationFrameId);\r\n      }\r\n    };\r\n  }, [\r\n    modelsLoaded,\r\n    cameraReady,\r\n    showLandmarks,\r\n    isProcessing,\r\n    modelLoadingError,\r\n    cameraError,\r\n  ]);\r\n\r\n  // 4. Capture and detect face\r\n  const captureImage = async () => {\r\n    // Basic checks\r\n    if (!webcamRef.current || !cameraReady || isProcessing || !modelsLoaded) {\r\n      let reason = \"Chưa sẵn sàng\";\r\n      if (!cameraReady) reason = \"Camera chưa sẵn sàng\";\r\n      else if (isProcessing) reason = \"Đang xử lý\";\r\n      else if (!modelsLoaded) reason = \"Mô hình chưa tải xong\";\r\n      enqueueSnackbar(`Không thể chụp ảnh: ${reason}`, { variant: \"warning\" });\r\n      return;\r\n    }\r\n    if (capturedImages.length >= requiredImages) {\r\n      enqueueSnackbar(`Đã chụp đủ ${requiredImages} ảnh.`, { variant: \"info\" });\r\n      return;\r\n    }\r\n\r\n    setIsProcessing(true);\r\n    setCaptureError(\"\"); // Clear previous capture error\r\n\r\n    try {\r\n      const imageSrc = webcamRef.current.getScreenshot({\r\n        width: videoConstraints.width.ideal,\r\n        height: videoConstraints.height.ideal,\r\n      });\r\n      if (!imageSrc) {\r\n        throw new Error(\"Không thể chụp ảnh từ webcam.\");\r\n      }\r\n\r\n      // Perform face detection\r\n      const detections = await detectFace(imageSrc);\r\n\r\n      if (!detections || !detections.descriptor) {\r\n        console.warn(\r\n          \"[FaceComponent] Face detection failed or no descriptor found.\"\r\n        );\r\n        enqueueSnackbar(\r\n          \"Không phát hiện được khuôn mặt rõ ràng. Hãy thử lại.\",\r\n          { variant: \"warning\" }\r\n        );\r\n        setIsProcessing(false); // Allow retry\r\n        return;\r\n      }\r\n\r\n      // Store image and descriptor\r\n      const newImageData = {\r\n        img: imageSrc,\r\n        descriptor: Array.from(detections.descriptor), // Ensure serializable\r\n      };\r\n      const updatedImages = [...capturedImages, newImageData];\r\n      setCapturedImages(updatedImages);\r\n\r\n      enqueueSnackbar(`Đã chụp ảnh ${updatedImages.length}/${requiredImages}`, {\r\n        variant: \"success\",\r\n        autoHideDuration: 1500,\r\n      });\r\n\r\n      // If enough images captured, notify parent immediately\r\n      if (updatedImages.length >= requiredImages) {\r\n        onFaceDataCapture(updatedImages); // Pass all captured data\r\n        enqueueSnackbar(`Đã chụp đủ ${requiredImages} ảnh!`, {\r\n          variant: \"info\",\r\n        });\r\n      }\r\n    } catch (err) {\r\n      console.error(\"[FaceComponent] Error capturing image:\", err);\r\n      const errorMsg = \"Lỗi khi chụp ảnh. Vui lòng thử lại.\";\r\n      setCaptureError(errorMsg);\r\n      enqueueSnackbar(errorMsg, { variant: \"error\" });\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  // 5. Reset capture\r\n  const resetCapture = () => {\r\n    setCapturedImages([]);\r\n    setCaptureError(\"\");\r\n    // Notify parent that data is cleared (optional, depends on parent needs)\r\n    // onFaceDataCapture(null); or onFaceDataCapture([]);\r\n    enqueueSnackbar(\"Đã xóa ảnh đã chụp, bạn có thể chụp lại.\", {\r\n      variant: \"info\",\r\n    });\r\n  };\r\n\r\n  // --- Render Logic ---\r\n\r\n  const renderCameraView = () => (\r\n    <Paper\r\n      elevation={2}\r\n      sx={{\r\n        position: \"relative\",\r\n        width: \"100%\",\r\n        maxWidth: `${videoConstraints.width.ideal}px`,\r\n        aspectRatio: `${videoConstraints.width.ideal} / ${videoConstraints.height.ideal}`,\r\n        margin: \"16px auto\",\r\n        overflow: \"hidden\",\r\n        bgcolor: \"grey.200\",\r\n        border: cameraError ? \"2px solid red\" : \"1px solid\",\r\n        borderColor: \"divider\",\r\n      }}\r\n    >\r\n      <Suspense\r\n        fallback={\r\n          <Box\r\n            sx={{\r\n              position: \"absolute\",\r\n              top: \"50%\",\r\n              left: \"50%\",\r\n              transform: \"translate(-50%, -50%)\",\r\n            }}\r\n          >\r\n            <CircularProgress />\r\n          </Box>\r\n        }\r\n      >\r\n        <Webcam\r\n          audio={false}\r\n          ref={webcamRef}\r\n          screenshotFormat=\"image/jpeg\"\r\n          videoConstraints={videoConstraints}\r\n          onUserMedia={handleUserMedia}\r\n          onUserMediaError={handleUserMediaError}\r\n          style={{\r\n            display: \"block\",\r\n            width: \"100%\",\r\n            height: \"100%\",\r\n            objectFit: \"cover\",\r\n          }}\r\n        />\r\n        <canvas\r\n          ref={canvasRef}\r\n          style={{\r\n            position: \"absolute\",\r\n            top: 0,\r\n            left: 0,\r\n            width: \"100%\",\r\n            height: \"100%\",\r\n            display: showLandmarks ? \"block\" : \"none\",\r\n          }}\r\n        />\r\n      </Suspense>\r\n\r\n      {/* Loading/Error Overlay */}\r\n      {(!modelsLoaded || !cameraReady || cameraError || modelLoadingError) && (\r\n        <Box\r\n          sx={{\r\n            position: \"absolute\",\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundColor: \"rgba(0, 0, 0, 0.5)\",\r\n            display: \"flex\",\r\n            flexDirection: \"column\",\r\n            justifyContent: \"center\",\r\n            alignItems: \"center\",\r\n            color: \"white\",\r\n            textAlign: \"center\",\r\n            p: 2,\r\n          }}\r\n        >\r\n          <CircularProgress color=\"inherit\" sx={{ mb: 2 }} />\r\n          {modelLoadingError && (\r\n            <Typography variant=\"body2\" color=\"error\">\r\n              {modelLoadingError}\r\n            </Typography>\r\n          )}\r\n          {cameraError && (\r\n            <Typography variant=\"body2\" color=\"error\">\r\n              {cameraError}\r\n            </Typography>\r\n          )}\r\n          {!modelLoadingError && !cameraError && !modelsLoaded && (\r\n            <Typography>Đang tải mô hình...</Typography>\r\n          )}\r\n          {!modelLoadingError &&\r\n            !cameraError &&\r\n            modelsLoaded &&\r\n            !cameraReady && <Typography>Đang khởi động camera...</Typography>}\r\n        </Box>\r\n      )}\r\n    </Paper>\r\n  );\r\n\r\n  const renderCaptureControls = () => (\r\n    <Box sx={{ textAlign: \"center\", mt: 2 }}>\r\n      <FormControlLabel\r\n        control={\r\n          <Switch\r\n            checked={showLandmarks}\r\n            onChange={(e) => setShowLandmarks(e.target.checked)}\r\n            size=\"small\"\r\n          />\r\n        }\r\n        label=\"Hiện Landmark\"\r\n        sx={{ mb: 1, display: \"block\" }}\r\n      />\r\n      <Button\r\n        variant=\"contained\"\r\n        color=\"primary\"\r\n        startIcon={<CameraAlt />}\r\n        onClick={captureImage}\r\n        disabled={\r\n          !cameraReady ||\r\n          !modelsLoaded ||\r\n          isProcessing ||\r\n          capturedImages.length >= requiredImages ||\r\n          !!cameraError ||\r\n          !!modelLoadingError\r\n        }\r\n        sx={{ mb: 1, mr: 1 }}\r\n      >\r\n        {isProcessing ? (\r\n          <CircularProgress size={24} color=\"inherit\" />\r\n        ) : (\r\n          `Chụp ảnh (${capturedImages.length}/${requiredImages})`\r\n        )}\r\n      </Button>\r\n      <Button\r\n        variant=\"outlined\"\r\n        color=\"warning\"\r\n        startIcon={<Replay />}\r\n        onClick={resetCapture}\r\n        disabled={capturedImages.length === 0 || isProcessing}\r\n        sx={{ mb: 1 }}\r\n      >\r\n        Chụp lại\r\n      </Button>\r\n      {captureError && (\r\n        <Alert severity=\"error\" sx={{ mt: 2, textAlign: \"left\" }}>\r\n          {captureError}\r\n        </Alert>\r\n      )}\r\n    </Box>\r\n  );\r\n\r\n  const renderImagePreviews = () =>\r\n    capturedImages.length > 0 && (\r\n      <Box sx={{ mt: 2, textAlign: \"center\" }}>\r\n        <Typography variant=\"caption\" display=\"block\" gutterBottom>\r\n          Ảnh đã chụp:\r\n        </Typography>\r\n        <Stack\r\n          direction=\"row\"\r\n          spacing={1}\r\n          justifyContent=\"center\"\r\n          flexWrap=\"wrap\"\r\n        >\r\n          {capturedImages.map((imgData, index) => (\r\n            <Avatar\r\n              key={index}\r\n              src={imgData.img}\r\n              sx={{ width: 56, height: 56 }}\r\n            />\r\n          ))}\r\n          {/* Placeholders for remaining slots */}\r\n          {[...Array(Math.max(0, requiredImages - capturedImages.length))].map(\r\n            (_, i) => (\r\n              <Avatar\r\n                key={`placeholder-${i}`}\r\n                sx={{ width: 56, height: 56, bgcolor: \"grey.300\" }}\r\n              >\r\n                <Person />\r\n              </Avatar>\r\n            )\r\n          )}\r\n        </Stack>\r\n      </Box>\r\n    );\r\n\r\n  // --- Main Component Render ---\r\n  return (\r\n    <Box>\r\n      {/* Show general loading/error before camera */}\r\n      {!modelsLoaded && !modelLoadingError && (\r\n        <Box\r\n          sx={{\r\n            display: \"flex\",\r\n            justifyContent: \"center\",\r\n            alignItems: \"center\",\r\n            p: 2,\r\n          }}\r\n        >\r\n          <CircularProgress size={20} sx={{ mr: 1 }} />\r\n          <Typography>Đang tải mô hình nhận diện...</Typography>\r\n        </Box>\r\n      )}\r\n      {modelLoadingError && (\r\n        <Alert severity=\"error\" sx={{ mb: 2 }}>\r\n          {modelLoadingError}\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Render Camera and Controls once models attempt to load */}\r\n      {modelsLoaded && !modelLoadingError && (\r\n        <>\r\n          {renderCameraView()}\r\n          {renderCaptureControls()}\r\n          {renderImagePreviews()}\r\n        </>\r\n      )}\r\n      {/* Optional: Add a success message when all images are captured */}\r\n      {capturedImages.length >= requiredImages && (\r\n        <Alert\r\n          severity=\"success\"\r\n          icon={<CheckCircleOutline fontSize=\"inherit\" />}\r\n          sx={{ mt: 2 }}\r\n        >\r\n          Đã chụp đủ {requiredImages} ảnh. Bạn có thể tiếp tục.\r\n        </Alert>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default FaceRegistrationComponent;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}