{"ast":null,"code":"import React,{useState,useEffect}from\"react\";import{useNavigate}from\"react-router-dom\";import{useSelector}from\"react-redux\";import{useSnackbar}from\"notistack\";import axios from\"axios\";import{Box,Typography,Card,CardContent,Grid,Paper,Button,TextField,CircularProgress,Table,TableBody,TableCell,TableContainer,TableHead,TableRow,TablePagination,InputAdornment,FormControl,InputLabel,Select,MenuItem,Chip,Divider,Stack,LinearProgress,Tooltip}from\"@mui/material\";import{Search,School,CalendarToday,AccessTime,VerifiedUser,Warning,Visibility}from\"@mui/icons-material\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||\"http://localhost:5000/api\";const StudentClassesPage=()=>{const navigate=useNavigate();const{enqueueSnackbar}=useSnackbar();const{user,token}=useSelector(state=>state.auth);// State cho dữ liệu\nconst[classes,setClasses]=useState([]);const[semesters,setSemesters]=useState([]);const[attendanceStats,setAttendanceStats]=useState({});const[isLoading,setIsLoading]=useState(true);const[totalClasses,setTotalClasses]=useState(0);// State cho tìm kiếm và phân trang\nconst[search,setSearch]=useState(\"\");const[semester,setSemester]=useState(\"\");const[academicYear,setAcademicYear]=useState(\"\");const[page,setPage]=useState(0);const[rowsPerPage,setRowsPerPage]=useState(10);// State cho thông tin đăng ký khuôn mặt\nconst[faceRegistrationStatus,setFaceRegistrationStatus]=useState(false);// Load dữ liệu ban đầu\nuseEffect(()=>{const fetchInitialData=async()=>{try{setIsLoading(true);// Kiểm tra trạng thái đăng ký khuôn mặt\nconst userResponse=await axios.get(`${API_URL}/auth/me`,{headers:{Authorization:`Bearer ${token}`}});setFaceRegistrationStatus(userResponse.data.data.face_registered||false);// Load các học kỳ\nconst semestersResponse=await axios.get(`${API_URL}/semesters`,{headers:{Authorization:`Bearer ${token}`}});setSemesters(semestersResponse.data.data||[]);// Load lớp học theo mặc định\nawait fetchClasses();}catch(error){console.error(\"Lỗi khi tải dữ liệu:\",error);enqueueSnackbar(\"Lỗi khi tải dữ liệu\",{variant:\"error\"});}finally{setIsLoading(false);}};fetchInitialData();},[token,enqueueSnackbar,user._id]);// Tải danh sách lớp học\nconst fetchClasses=async()=>{try{setIsLoading(true);let url=`${API_URL}/classes/teaching/student/${user._id}?page=${page+1}&limit=${rowsPerPage}`;if(search){url+=`&search=${encodeURIComponent(search)}`;}if(semester){url+=`&semester=${semester}`;}if(academicYear){url+=`&academic_year=${academicYear}`;}const response=await axios.get(url,{headers:{Authorization:`Bearer ${token}`}});const classesData=response.data.data||[];setClasses(classesData);setTotalClasses(response.data.count||0);// Lấy thống kê điểm danh cho từng lớp\nconst statsPromises=classesData.map(async classItem=>{try{const attendanceResponse=await axios.get(`${API_URL}/attendance/student/${user._id}/logs?teaching_class=${classItem._id}`,{headers:{Authorization:`Bearer ${token}`}});// Tính số buổi tham gia, vắng mặt\nconst logs=attendanceResponse.data.data||[];const totalSessions=logs.length;let present=0;let absent=0;let late=0;logs.forEach(log=>{if(log.status===\"present\")present++;else if(log.status===\"late\")late++;else if(log.status===\"absent\")absent++;});return{classId:classItem._id,stats:{total:totalSessions,present,absent,late,attendanceRate:totalSessions>0?(present+late)/totalSessions*100:0}};}catch(error){console.error(`Lỗi khi lấy thống kê điểm danh cho lớp ${classItem._id}:`,error);return{classId:classItem._id,stats:{total:0,present:0,absent:0,late:0,attendanceRate:0}};}});const statsResults=await Promise.all(statsPromises);const statsMap={};statsResults.forEach(result=>{statsMap[result.classId]=result.stats;});setAttendanceStats(statsMap);}catch(error){console.error(\"Lỗi khi tải danh sách lớp học:\",error);enqueueSnackbar(\"Lỗi khi tải danh sách lớp học\",{variant:\"error\"});}finally{setIsLoading(false);}};// Xử lý thay đổi trang hoặc số dòng mỗi trang\nuseEffect(()=>{fetchClasses();},[page,rowsPerPage,token]);// Xử lý tìm kiếm\nconst handleSearch=()=>{setPage(0);// Reset về trang đầu tiên\nfetchClasses();};// Xử lý thay đổi trang\nconst handleChangePage=(event,newPage)=>{setPage(newPage);};// Xử lý thay đổi số dòng mỗi trang\nconst handleChangeRowsPerPage=event=>{setRowsPerPage(parseInt(event.target.value,10));setPage(0);};// Xử lý khi nhấn Enter trong ô tìm kiếm\nconst handleSearchKeyDown=e=>{if(e.key===\"Enter\"){handleSearch();}};// Lọc theo học kỳ hoặc năm học\nconst handleFilterChange=()=>{setPage(0);fetchClasses();};// Mở trang chi tiết lớp học\nconst handleViewAttendance=classId=>{navigate(`/student/attendance/${classId}`);};// Đăng ký khuôn mặt\nconst handleRegisterFace=()=>{navigate(\"/register-face\");};// Lấy danh sách các năm học từ các học kỳ\nconst getAcademicYears=()=>{const years=new Set();semesters.forEach(sem=>{if(sem.academic_year){years.add(sem.academic_year);}});return Array.from(years).sort().reverse();};// Render trạng thái lớp học\nconst renderClassStatus=classItem=>{if(!classItem.is_active){return/*#__PURE__*/_jsx(Chip,{label:\"\\u0110\\xE3 k\\u1EBFt th\\xFAc\",color:\"default\",size:\"small\"});}if(classItem.is_active){return/*#__PURE__*/_jsx(Chip,{label:\"\\u0110ang ho\\u1EA1t \\u0111\\u1ED9ng\",color:\"success\",size:\"small\"});}return/*#__PURE__*/_jsx(Chip,{label:\"Ch\\u01B0a b\\u1EAFt \\u0111\\u1EA7u\",color:\"primary\",size:\"small\"});};return/*#__PURE__*/_jsxs(Box,{sx:{padding:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",gutterBottom:true,children:\"L\\u1EDBp h\\u1ECDc c\\u1EE7a t\\xF4i\"}),!faceRegistrationStatus&&/*#__PURE__*/_jsx(Paper,{sx:{p:2,mb:3,bgcolor:\"warning.light\"},children:/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\"},children:[/*#__PURE__*/_jsx(Warning,{color:\"warning\",sx:{mr:2}}),/*#__PURE__*/_jsxs(Box,{sx:{flex:1},children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",children:\"B\\u1EA1n ch\\u01B0a \\u0111\\u0103ng k\\xFD khu\\xF4n m\\u1EB7t cho h\\u1EC7 th\\u1ED1ng \\u0111i\\u1EC3m danh!\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",children:\"\\u0110\\u1EC3 c\\xF3 th\\u1EC3 \\u0111i\\u1EC3m danh b\\u1EB1ng khu\\xF4n m\\u1EB7t, b\\u1EA1n c\\u1EA7n \\u0111\\u0103ng k\\xFD khu\\xF4n m\\u1EB7t tr\\u01B0\\u1EDBc.\"})]}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:handleRegisterFace,startIcon:/*#__PURE__*/_jsx(VerifiedUser,{}),children:\"\\u0110\\u0103ng k\\xFD khu\\xF4n m\\u1EB7t\"})]})}),/*#__PURE__*/_jsx(Paper,{sx:{p:2,mb:3},children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,alignItems:\"center\",children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:4,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,label:\"T\\xECm ki\\u1EBFm l\\u1EDBp h\\u1ECDc\",variant:\"outlined\",value:search,onChange:e=>setSearch(e.target.value),onKeyDown:handleSearchKeyDown,InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsx(Search,{})})}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",children:[/*#__PURE__*/_jsx(InputLabel,{children:\"H\\u1ECDc k\\u1EF3\"}),/*#__PURE__*/_jsxs(Select,{value:semester,onChange:e=>{setSemester(e.target.value);handleFilterChange();},label:\"H\\u1ECDc k\\u1EF3\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"T\\u1EA5t c\\u1EA3 h\\u1ECDc k\\u1EF3\"}),semesters.map(sem=>/*#__PURE__*/_jsxs(MenuItem,{value:sem._id,children:[sem.name,\" (\",sem.academic_year,\")\"]},sem._id))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",children:[/*#__PURE__*/_jsx(InputLabel,{children:\"N\\u0103m h\\u1ECDc\"}),/*#__PURE__*/_jsxs(Select,{value:academicYear,onChange:e=>{setAcademicYear(e.target.value);handleFilterChange();},label:\"N\\u0103m h\\u1ECDc\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"T\\u1EA5t c\\u1EA3 n\\u0103m h\\u1ECDc\"}),getAcademicYears().map(year=>/*#__PURE__*/_jsx(MenuItem,{value:year,children:year},year))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:2,children:/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",fullWidth:true,onClick:handleSearch,children:\"T\\xECm ki\\u1EBFm\"})})]})}),/*#__PURE__*/_jsx(Paper,{children:isLoading?/*#__PURE__*/_jsx(Box,{sx:{width:\"100%\"},children:/*#__PURE__*/_jsx(LinearProgress,{})}):/*#__PURE__*/_jsxs(TableContainer,{children:[/*#__PURE__*/_jsxs(Table,{children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:\"T\\xEAn l\\u1EDBp\"}),/*#__PURE__*/_jsx(TableCell,{children:\"M\\xE3 h\\u1ECDc ph\\u1EA7n\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Gi\\u1EA3ng vi\\xEAn\"}),/*#__PURE__*/_jsx(TableCell,{children:\"H\\u1ECDc k\\u1EF3\"}),/*#__PURE__*/_jsx(TableCell,{children:\"T\\u1EF7 l\\u1EC7 \\u0111i\\u1EC3m danh\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Tr\\u1EA1ng th\\xE1i\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Thao t\\xE1c\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:classes.length>0?classes.map(classItem=>{var _classItem$course_id,_classItem$teacher_id,_attendanceStats$clas,_attendanceStats$clas2,_attendanceStats$clas3,_attendanceStats$clas4,_attendanceStats$clas5,_attendanceStats$clas6,_attendanceStats$clas7;return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:classItem.class_name}),/*#__PURE__*/_jsx(TableCell,{children:((_classItem$course_id=classItem.course_id)===null||_classItem$course_id===void 0?void 0:_classItem$course_id.code)||\"N/A\"}),/*#__PURE__*/_jsx(TableCell,{children:((_classItem$teacher_id=classItem.teacher_id)===null||_classItem$teacher_id===void 0?void 0:_classItem$teacher_id.full_name)||\"N/A\"}),/*#__PURE__*/_jsx(TableCell,{children:classItem.semester?typeof classItem.semester===\"object\"?classItem.semester.name:\"N/A\":\"N/A\"}),/*#__PURE__*/_jsxs(TableCell,{children:[/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\"},children:[/*#__PURE__*/_jsx(Box,{sx:{width:\"100%\",mr:1},children:/*#__PURE__*/_jsx(LinearProgress,{variant:\"determinate\",value:((_attendanceStats$clas=attendanceStats[classItem._id])===null||_attendanceStats$clas===void 0?void 0:_attendanceStats$clas.attendanceRate)||0,color:(((_attendanceStats$clas2=attendanceStats[classItem._id])===null||_attendanceStats$clas2===void 0?void 0:_attendanceStats$clas2.attendanceRate)||0)>=80?\"success\":(((_attendanceStats$clas3=attendanceStats[classItem._id])===null||_attendanceStats$clas3===void 0?void 0:_attendanceStats$clas3.attendanceRate)||0)>=50?\"warning\":\"error\",sx:{height:10,borderRadius:5}})}),/*#__PURE__*/_jsx(Box,{sx:{minWidth:35},children:/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",color:\"text.secondary\",children:[Math.round(((_attendanceStats$clas4=attendanceStats[classItem._id])===null||_attendanceStats$clas4===void 0?void 0:_attendanceStats$clas4.attendanceRate)||0),\"%\"]})})]}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",display:\"block\",children:`${((_attendanceStats$clas5=attendanceStats[classItem._id])===null||_attendanceStats$clas5===void 0?void 0:_attendanceStats$clas5.present)||0} có mặt, ${((_attendanceStats$clas6=attendanceStats[classItem._id])===null||_attendanceStats$clas6===void 0?void 0:_attendanceStats$clas6.late)||0} muộn, ${((_attendanceStats$clas7=attendanceStats[classItem._id])===null||_attendanceStats$clas7===void 0?void 0:_attendanceStats$clas7.absent)||0} vắng`})]}),/*#__PURE__*/_jsx(TableCell,{children:renderClassStatus(classItem)}),/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsx(Button,{variant:\"outlined\",size:\"small\",onClick:()=>handleViewAttendance(classItem._id),startIcon:/*#__PURE__*/_jsx(Visibility,{}),children:\"Xem\"})})]},classItem._id);}):/*#__PURE__*/_jsx(TableRow,{children:/*#__PURE__*/_jsx(TableCell,{colSpan:7,align:\"center\",children:\"Kh\\xF4ng c\\xF3 l\\u1EDBp h\\u1ECDc n\\xE0o.\"})})})]}),/*#__PURE__*/_jsx(TablePagination,{rowsPerPageOptions:[5,10,25],component:\"div\",count:totalClasses,rowsPerPage:rowsPerPage,page:page,onPageChange:handleChangePage,onRowsPerPageChange:handleChangeRowsPerPage,labelRowsPerPage:\"D\\xF2ng m\\u1ED7i trang:\",labelDisplayedRows:_ref=>{let{from,to,count}=_ref;return`${from}-${to} trong số ${count!==-1?count:`hơn ${to}`}`;}})]})})]});};export default StudentClassesPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}