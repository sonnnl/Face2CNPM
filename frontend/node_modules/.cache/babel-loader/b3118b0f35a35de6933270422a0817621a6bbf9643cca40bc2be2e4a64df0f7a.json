{"ast":null,"code":"import React,{useState,useEffect}from\"react\";import{useDispatch,useSelector}from\"react-redux\";import{useSnackbar}from\"notistack\";import{Box,Typography,Card,CardContent,Button,IconButton,TextField,Paper,Table,TableBody,TableCell,TableContainer,TableHead,TableRow,TablePagination,Chip,Dialog,DialogActions,DialogContent,DialogContentText,DialogTitle,FormControl,InputLabel,Select,MenuItem,Grid,Tooltip,Avatar,CircularProgress,InputAdornment}from\"@mui/material\";import{Add,Delete,Edit,Search,Check,Close,Refresh,VerifiedUser,Person,School,SupervisorAccount}from\"@mui/icons-material\";import{fetchAllUsers,approveUser,rejectUser,updateUserRole,deleteUser}from\"../../redux/slices/adminSlice\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const ROLES=[{value:\"admin\",label:\"Admin\",color:\"error\"},{value:\"teacher\",label:\"Giáo viên\",color:\"primary\"},{value:\"student\",label:\"Sinh viên\",color:\"success\"}];const STATUS=[{value:\"pending\",label:\"Chờ phê duyệt\",color:\"warning\"},{value:\"approved\",label:\"Đã phê duyệt\",color:\"success\"},{value:\"rejected\",label:\"Đã từ chối\",color:\"error\"}];const UsersPage=()=>{const dispatch=useDispatch();const{enqueueSnackbar}=useSnackbar();const{users,userStats,isLoading,error,pagination}=useSelector(state=>state.admin);const{token}=useSelector(state=>state.auth);const[searchTerm,setSearchTerm]=useState(\"\");const[roleFilter,setRoleFilter]=useState(\"\");const[statusFilter,setStatusFilter]=useState(\"\");const[page,setPage]=useState(0);const[rowsPerPage,setRowsPerPage]=useState(10);// Dialog states\nconst[deleteDialogOpen,setDeleteDialogOpen]=useState(false);const[selectedUser,setSelectedUser]=useState(null);const[roleDialogOpen,setRoleDialogOpen]=useState(false);const[selectedRole,setSelectedRole]=useState(\"\");const[confirmDialogOpen,setConfirmDialogOpen]=useState(false);const[confirmAction,setConfirmAction]=useState(null);useEffect(()=>{loadUsers();},[dispatch,page,rowsPerPage,roleFilter,statusFilter]);useEffect(()=>{if(error){enqueueSnackbar(error,{variant:\"error\"});}},[error,enqueueSnackbar]);const loadUsers=()=>{dispatch(fetchAllUsers({page:page+1,limit:rowsPerPage,search:searchTerm,role:roleFilter,status:statusFilter}));};const handleSearch=()=>{setPage(0);loadUsers();};const handleRoleFilterChange=event=>{setRoleFilter(event.target.value);setPage(0);};const handleStatusFilterChange=event=>{setStatusFilter(event.target.value);setPage(0);};const handleChangePage=(event,newPage)=>{setPage(newPage);};const handleChangeRowsPerPage=event=>{setRowsPerPage(parseInt(event.target.value,10));setPage(0);};const openConfirmDialog=(user,action)=>{setSelectedUser(user);setConfirmAction(action);setConfirmDialogOpen(true);};const handleApproveUser=async()=>{if(!selectedUser)return;try{await dispatch(approveUser(selectedUser._id)).unwrap();enqueueSnackbar(\"Phê duyệt người dùng thành công\",{variant:\"success\"});setConfirmDialogOpen(false);}catch(error){enqueueSnackbar((error===null||error===void 0?void 0:error.message)||\"Lỗi khi phê duyệt người dùng\",{variant:\"error\"});}};const handleRejectUser=async()=>{if(!selectedUser)return;try{await dispatch(rejectUser(selectedUser._id)).unwrap();enqueueSnackbar(\"Từ chối người dùng thành công\",{variant:\"success\"});setConfirmDialogOpen(false);}catch(error){enqueueSnackbar((error===null||error===void 0?void 0:error.message)||\"Lỗi khi từ chối người dùng\",{variant:\"error\"});}};const openRoleDialog=user=>{setSelectedUser(user);setSelectedRole(user.role);setRoleDialogOpen(true);};const handleRoleChange=async()=>{if(!selectedUser||!selectedRole)return;try{await dispatch(updateUserRole({userId:selectedUser._id,role:selectedRole})).unwrap();enqueueSnackbar(\"Cập nhật vai trò thành công\",{variant:\"success\"});setRoleDialogOpen(false);}catch(error){enqueueSnackbar((error===null||error===void 0?void 0:error.message)||\"Lỗi khi cập nhật vai trò\",{variant:\"error\"});}};const openDeleteDialog=user=>{setSelectedUser(user);setDeleteDialogOpen(true);};const handleDeleteUser=async()=>{if(!selectedUser)return;try{await dispatch(deleteUser(selectedUser._id)).unwrap();enqueueSnackbar(\"Xóa người dùng thành công\",{variant:\"success\"});setDeleteDialogOpen(false);}catch(error){enqueueSnackbar((error===null||error===void 0?void 0:error.message)||\"Lỗi khi xóa người dùng\",{variant:\"error\"});}};return/*#__PURE__*/_jsxs(Box,{p:3,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",gutterBottom:true,children:\"Qu\\u1EA3n l\\xFD ng\\u01B0\\u1EDDi d\\xF9ng\"}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:3,mb:3,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,md:3,children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",color:\"textSecondary\",gutterBottom:true,sx:{fontSize:\"1rem\"},children:\"T\\u1ED5ng ng\\u01B0\\u1EDDi d\\xF9ng \\u0111\\xE3 ph\\xEA duy\\u1EC7t\"}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(Person,{sx:{mr:1,color:\"text.secondary\",fontSize:40}}),/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:userStats.totalApprovedUsers||0})]})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,md:3,children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",color:\"textSecondary\",gutterBottom:true,sx:{fontSize:\"1rem\"},children:\"Gi\\xE1o vi\\xEAn\"}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(SupervisorAccount,{sx:{mr:1,color:\"primary.main\",fontSize:40}}),/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:userStats.approvedTeachers||0})]})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,md:3,children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",color:\"textSecondary\",gutterBottom:true,sx:{fontSize:\"1rem\"},children:\"Sinh vi\\xEAn\"}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(School,{sx:{mr:1,color:\"success.main\",fontSize:40}}),/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:userStats.approvedStudents||0})]})]})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,md:3,children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",color:\"textSecondary\",gutterBottom:true,sx:{fontSize:\"1rem\"},children:\"Ch\\u1EDD ph\\xEA duy\\u1EC7t\"}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(VerifiedUser,{sx:{mr:1,color:\"warning.main\",fontSize:40}}),/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:(userStats.pendingTeachers||0)+(userStats.pendingStudents||0)})]})]})})})]}),/*#__PURE__*/_jsx(Paper,{sx:{p:2,mb:3},children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,alignItems:\"flex-end\",children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:4,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,label:\"T\\xECm ki\\u1EBFm ng\\u01B0\\u1EDDi d\\xF9ng\",variant:\"outlined\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),onKeyDown:e=>e.key===\"Enter\"&&handleSearch(),InputProps:{endAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"end\",children:/*#__PURE__*/_jsx(IconButton,{onClick:handleSearch,children:/*#__PURE__*/_jsx(Search,{})})})}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",children:[/*#__PURE__*/_jsx(InputLabel,{id:\"role-filter-label\",children:\"Vai tr\\xF2\"}),/*#__PURE__*/_jsxs(Select,{labelId:\"role-filter-label\",id:\"role-filter\",value:roleFilter,onChange:handleRoleFilterChange,label:\"Vai tr\\xF2\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"T\\u1EA5t c\\u1EA3\"}),ROLES.map(role=>/*#__PURE__*/_jsx(MenuItem,{value:role.value,children:role.label},role.value))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",children:[/*#__PURE__*/_jsx(InputLabel,{id:\"status-filter-label\",children:\"Tr\\u1EA1ng th\\xE1i\"}),/*#__PURE__*/_jsxs(Select,{labelId:\"status-filter-label\",id:\"status-filter\",value:statusFilter,onChange:handleStatusFilterChange,label:\"Tr\\u1EA1ng th\\xE1i\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"T\\u1EA5t c\\u1EA3\"}),STATUS.map(status=>/*#__PURE__*/_jsx(MenuItem,{value:status.value,children:status.label},status.value))]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:2,sx:{display:\"flex\",justifyContent:\"flex-end\"},children:/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/_jsx(Refresh,{}),onClick:loadUsers,children:\"L\\xE0m m\\u1EDBi\"})})]})}),/*#__PURE__*/_jsxs(TableContainer,{component:Paper,children:[/*#__PURE__*/_jsxs(Table,{sx:{minWidth:650},children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:\"Th\\xF4ng tin\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Email\"}),/*#__PURE__*/_jsx(TableCell,{children:\"Vai tr\\xF2\"}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:\"Tr\\u1EA1ng th\\xE1i\"}),/*#__PURE__*/_jsx(TableCell,{align:\"right\",children:\"Thao t\\xE1c\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:isLoading?/*#__PURE__*/_jsx(TableRow,{children:/*#__PURE__*/_jsx(TableCell,{colSpan:5,align:\"center\",sx:{py:3},children:/*#__PURE__*/_jsx(CircularProgress,{})})}):users.length===0?/*#__PURE__*/_jsx(TableRow,{children:/*#__PURE__*/_jsx(TableCell,{colSpan:5,align:\"center\",sx:{py:3},children:\"Kh\\xF4ng c\\xF3 d\\u1EEF li\\u1EC7u\"})}):users.map(user=>{var _user$school_info,_ROLES$find,_ROLES$find2,_STATUS$find,_STATUS$find2;return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(Avatar,{src:user.avatar_url,sx:{mr:2},alt:user.full_name}),/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"body1\",children:user.full_name}),((_user$school_info=user.school_info)===null||_user$school_info===void 0?void 0:_user$school_info.student_code)&&/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",color:\"textSecondary\",children:[\"MSSV: \",user.school_info.student_code]})]})]})}),/*#__PURE__*/_jsx(TableCell,{children:user.email}),/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsx(Chip,{label:((_ROLES$find=ROLES.find(r=>r.value===user.role))===null||_ROLES$find===void 0?void 0:_ROLES$find.label)||user.role,color:((_ROLES$find2=ROLES.find(r=>r.value===user.role))===null||_ROLES$find2===void 0?void 0:_ROLES$find2.color)||\"default\",size:\"small\"})}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Chip,{label:((_STATUS$find=STATUS.find(s=>s.value===user.status))===null||_STATUS$find===void 0?void 0:_STATUS$find.label)||user.status,color:((_STATUS$find2=STATUS.find(s=>s.value===user.status))===null||_STATUS$find2===void 0?void 0:_STATUS$find2.color)||\"default\",size:\"small\"})}),/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsxs(Box,{display:\"flex\",justifyContent:\"flex-end\",children:[user.status===\"pending\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Tooltip,{title:\"Ph\\xEA duy\\u1EC7t\",children:/*#__PURE__*/_jsx(IconButton,{color:\"success\",onClick:()=>openConfirmDialog(user,\"approve\"),children:/*#__PURE__*/_jsx(Check,{})})}),/*#__PURE__*/_jsx(Tooltip,{title:\"T\\u1EEB ch\\u1ED1i\",children:/*#__PURE__*/_jsx(IconButton,{color:\"error\",onClick:()=>openConfirmDialog(user,\"reject\"),children:/*#__PURE__*/_jsx(Close,{})})})]}),/*#__PURE__*/_jsx(Tooltip,{title:\"Thay \\u0111\\u1ED5i vai tr\\xF2\",children:/*#__PURE__*/_jsx(IconButton,{color:\"primary\",onClick:()=>openRoleDialog(user),children:/*#__PURE__*/_jsx(Edit,{})})}),/*#__PURE__*/_jsx(Tooltip,{title:\"X\\xF3a ng\\u01B0\\u1EDDi d\\xF9ng\",children:/*#__PURE__*/_jsx(IconButton,{color:\"error\",onClick:()=>openDeleteDialog(user),children:/*#__PURE__*/_jsx(Delete,{})})})]})})]},user._id);})})]}),/*#__PURE__*/_jsx(TablePagination,{rowsPerPageOptions:[5,10,25],component:\"div\",count:pagination.totalCount,rowsPerPage:rowsPerPage,page:page,onPageChange:handleChangePage,onRowsPerPageChange:handleChangeRowsPerPage,labelRowsPerPage:\"D\\xF2ng m\\u1ED7i trang:\",labelDisplayedRows:_ref=>{let{from,to,count}=_ref;return`${from}-${to} trên ${count}`;}})]}),/*#__PURE__*/_jsxs(Dialog,{open:confirmDialogOpen,onClose:()=>setConfirmDialogOpen(false),children:[/*#__PURE__*/_jsx(DialogTitle,{children:confirmAction===\"approve\"?\"Phê duyệt người dùng\":\"Từ chối người dùng\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(DialogContentText,{children:confirmAction===\"approve\"?`Bạn có chắc chắn muốn phê duyệt người dùng ${(selectedUser===null||selectedUser===void 0?void 0:selectedUser.full_name)||\"\"}?`:`Bạn có chắc chắn muốn từ chối người dùng ${(selectedUser===null||selectedUser===void 0?void 0:selectedUser.full_name)||\"\"}?`})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setConfirmDialogOpen(false),children:\"H\\u1EE7y\"}),/*#__PURE__*/_jsx(Button,{onClick:confirmAction===\"approve\"?handleApproveUser:handleRejectUser,color:confirmAction===\"approve\"?\"primary\":\"error\",autoFocus:true,children:\"X\\xE1c nh\\u1EADn\"})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:roleDialogOpen,onClose:()=>setRoleDialogOpen(false),children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Thay \\u0111\\u1ED5i vai tr\\xF2 ng\\u01B0\\u1EDDi d\\xF9ng\"}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogContentText,{sx:{mb:2},children:[\"Ch\\u1ECDn vai tr\\xF2 m\\u1EDBi cho \",(selectedUser===null||selectedUser===void 0?void 0:selectedUser.full_name)||\"\"]}),/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"role-select-label\",children:\"Vai tr\\xF2\"}),/*#__PURE__*/_jsx(Select,{labelId:\"role-select-label\",value:selectedRole,onChange:e=>setSelectedRole(e.target.value),label:\"Vai tr\\xF2\",children:ROLES.map(role=>/*#__PURE__*/_jsx(MenuItem,{value:role.value,children:role.label},role.value))})]})]}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setRoleDialogOpen(false),children:\"H\\u1EE7y\"}),/*#__PURE__*/_jsx(Button,{onClick:handleRoleChange,color:\"primary\",children:\"C\\u1EADp nh\\u1EADt\"})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:deleteDialogOpen,onClose:()=>setDeleteDialogOpen(false),children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"X\\xF3a ng\\u01B0\\u1EDDi d\\xF9ng\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(DialogContentText,{children:[\"B\\u1EA1n c\\xF3 ch\\u1EAFc ch\\u1EAFn mu\\u1ED1n x\\xF3a ng\\u01B0\\u1EDDi d\\xF9ng \",(selectedUser===null||selectedUser===void 0?void 0:selectedUser.full_name)||\"\",\"? H\\xE0nh \\u0111\\u1ED9ng n\\xE0y kh\\xF4ng th\\u1EC3 ho\\xE0n t\\xE1c.\"]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:()=>setDeleteDialogOpen(false),children:\"H\\u1EE7y\"}),/*#__PURE__*/_jsx(Button,{onClick:handleDeleteUser,color:\"error\",autoFocus:true,children:\"X\\xF3a\"})]})]})]});};export default UsersPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}