{"ast":null,"code":"import React,{useState,useEffect,useRef}from\"react\";import{useDispatch,useSelector}from\"react-redux\";import{useNavigate}from\"react-router-dom\";import{Container,Box,TextField,Button,Typography,Paper,Grid,Divider,IconButton,InputAdornment,Alert,CircularProgress,Link}from\"@mui/material\";import{Google,Visibility,VisibilityOff,DeleteForever}from\"@mui/icons-material\";import{useSnackbar}from\"notistack\";import{login,clearError,resetLoading,logout,setCredentials}from\"../redux/slices/authSlice\";import axios from\"../utils/axios\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||\"http://localhost:5000/api\";const LoginPage=()=>{const dispatch=useDispatch();const navigate=useNavigate();const{enqueueSnackbar}=useSnackbar();const{isAuthenticated,isLoading,error,user}=useSelector(state=>state.auth);const[formData,setFormData]=useState({email:\"\",password:\"\"});const[showPassword,setShowPassword]=useState(false);const[googleLoading,setGoogleLoading]=useState(false);const[localLoading,setLocalLoading]=useState(false);const[formErrors,setFormErrors]=useState({email:\"\",password:\"\"});const emailInputRef=useRef(null);const passwordInputRef=useRef(null);// Xử lý xóa dữ liệu đăng nhập\nconst handleClearLoginData=()=>{// Đăng xuất từ Redux store\ndispatch(logout());// Xóa tất cả localStorage\nlocalStorage.clear();// Xóa các cookies\ndocument.cookie.split(\";\").forEach(function(c){document.cookie=c.replace(/^ +/,\"\").replace(/=.*/,\"=;expires=\"+new Date().toUTCString()+\";path=/\");});enqueueSnackbar(\"Đã xóa dữ liệu đăng nhập, bạn có thể đăng nhập lại\",{variant:\"success\"});// Làm mới trang để đảm bảo mọi thứ được đặt lại\nwindow.location.href=\"/login\";};// Thêm bảo vệ để tránh loading vô hạn\nuseEffect(()=>{let timeoutId;if(isLoading){// Nếu loading quá 10 giây, tự động đặt lại trạng thái\ntimeoutId=setTimeout(()=>{dispatch(resetLoading());enqueueSnackbar(\"Đã hết thời gian chờ. Vui lòng thử lại.\",{variant:\"warning\"});},10000);}return()=>{if(timeoutId)clearTimeout(timeoutId);};},[isLoading,dispatch,enqueueSnackbar]);useEffect(()=>{// Nếu đã đăng nhập, chuyển hướng đến trang chủ\nif(isAuthenticated){navigate(\"/dashboard\");}},[isAuthenticated,navigate]);useEffect(()=>{// Hiển thị lỗi nếu có\nif(error){enqueueSnackbar(error,{variant:\"error\"});dispatch(clearError());// Đảm bảo trạng thái loading được đặt lại\nif(isLoading){dispatch(resetLoading());}}},[error,enqueueSnackbar,dispatch,isLoading]);const handleChange=e=>{setFormData({...formData,[e.target.name]:e.target.value});};const handleSubmit=async e=>{e.preventDefault();// Reset form errors\nsetFormErrors({email:\"\",password:\"\"});// Validate form\nlet hasErrors=false;const errors={email:\"\",password:\"\"};if(!formData.email){var _emailInputRef$curren;errors.email=\"Email là bắt buộc\";hasErrors=true;(_emailInputRef$curren=emailInputRef.current)===null||_emailInputRef$curren===void 0?void 0:_emailInputRef$curren.focus();}else if(!/\\S+@\\S+\\.\\S+/.test(formData.email)){var _emailInputRef$curren2;errors.email=\"Email không hợp lệ\";hasErrors=true;(_emailInputRef$curren2=emailInputRef.current)===null||_emailInputRef$curren2===void 0?void 0:_emailInputRef$curren2.focus();}if(!formData.password){errors.password=\"Mật khẩu là bắt buộc\";hasErrors=true;if(!errors.email){var _passwordInputRef$cur;(_passwordInputRef$cur=passwordInputRef.current)===null||_passwordInputRef$cur===void 0?void 0:_passwordInputRef$cur.focus();}}if(hasErrors){setFormErrors(errors);return;}// Sử dụng axios trực tiếp thay vì Redux để ngăn reload trang\nsetLocalLoading(true);try{const response=await axios.post(`${API_URL}/auth/login`,formData);if(response.data.success){// Đăng nhập thành công, cập nhật redux store\ndispatch(setCredentials({token:response.data.token,user:response.data.user}));// Chuyển hướng đến trang chủ\nnavigate(\"/dashboard\");}}catch(error){var _error$response,_error$response$data;console.error(\"Login error:\",error);// Xử lý lỗi đăng nhập\nconst errorMessage=((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.message)||\"Đăng nhập thất bại\";if(errorMessage.includes(\"Email hoặc mật khẩu không đúng\")){var _passwordInputRef$cur2;setFormErrors({...errors,password:\"Email hoặc mật khẩu không đúng\"});(_passwordInputRef$cur2=passwordInputRef.current)===null||_passwordInputRef$cur2===void 0?void 0:_passwordInputRef$cur2.focus();}else{// Hiển thị thông báo lỗi\nenqueueSnackbar(errorMessage,{variant:\"error\"});}}finally{setLocalLoading(false);}};const handleGoogleLogin=()=>{try{setGoogleLoading(true);const apiUrl=process.env.REACT_APP_API_URL||\"http://localhost:5000/api\";// Thêm timestamp để tránh cache\nconst redirectUrl=`${apiUrl}/auth/google?t=${Date.now()}`;console.log(\"Redirecting to:\",redirectUrl);window.location.href=redirectUrl;}catch(error){console.error(\"Google login error:\",error);setGoogleLoading(false);enqueueSnackbar(\"Không thể kết nối đến dịch vụ Google. Vui lòng thử lại sau.\",{variant:\"error\"});}};const toggleShowPassword=()=>{setShowPassword(!showPassword);};return/*#__PURE__*/_jsxs(Container,{component:\"main\",maxWidth:\"sm\",children:[(isAuthenticated||localStorage.getItem(\"token\"))&&/*#__PURE__*/_jsx(Box,{mt:2,display:\"flex\",justifyContent:\"center\",children:/*#__PURE__*/_jsx(Alert,{severity:\"warning\",action:/*#__PURE__*/_jsx(Button,{color:\"inherit\",size:\"small\",startIcon:/*#__PURE__*/_jsx(DeleteForever,{}),onClick:handleClearLoginData,children:\"X\\xF3a d\\u1EEF li\\u1EC7u \\u0111\\u0103ng nh\\u1EADp\"}),children:\"B\\u1EA1n \\u0111ang g\\u1EB7p v\\u1EA5n \\u0111\\u1EC1 chuy\\u1EC3n h\\u01B0\\u1EDBng t\\u1EF1 \\u0111\\u1ED9ng?\"})}),/*#__PURE__*/_jsx(Box,{sx:{marginTop:8,display:\"flex\",flexDirection:\"column\",alignItems:\"center\"},children:/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{padding:4,width:\"100%\",borderRadius:3},children:[/*#__PURE__*/_jsx(Typography,{component:\"h1\",variant:\"h4\",align:\"center\",gutterBottom:true,children:\"\\u0110\\u0103ng Nh\\u1EADp\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",align:\"center\",color:\"text.secondary\",mb:3,children:\"H\\u1EC7 th\\u1ED1ng \\u0111i\\u1EC3m danh b\\u1EB1ng khu\\xF4n m\\u1EB7t\"}),/*#__PURE__*/_jsxs(Box,{component:\"form\",onSubmit:handleSubmit,noValidate:true,sx:{mt:1},children:[/*#__PURE__*/_jsx(TextField,{margin:\"normal\",required:true,fullWidth:true,id:\"email\",label:\"Email\",name:\"email\",autoComplete:\"email\",autoFocus:true,value:formData.email,onChange:handleChange,variant:\"outlined\",error:!!formErrors.email,helperText:formErrors.email,inputRef:emailInputRef}),/*#__PURE__*/_jsx(TextField,{margin:\"normal\",required:true,fullWidth:true,name:\"password\",label:\"M\\u1EADt kh\\u1EA9u\",type:showPassword?\"text\":\"password\",id:\"password\",autoComplete:\"current-password\",value:formData.password,onChange:handleChange,variant:\"outlined\",error:!!formErrors.password,helperText:formErrors.password,inputRef:passwordInputRef,InputProps:{endAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"end\",children:/*#__PURE__*/_jsx(IconButton,{\"aria-label\":\"toggle password visibility\",onClick:toggleShowPassword,edge:\"end\",children:showPassword?/*#__PURE__*/_jsx(VisibilityOff,{}):/*#__PURE__*/_jsx(Visibility,{})})})}}),/*#__PURE__*/_jsx(Button,{type:\"submit\",fullWidth:true,variant:\"contained\",sx:{mt:3,mb:2,py:1.5},disabled:localLoading,color:\"primary\",children:localLoading?/*#__PURE__*/_jsx(CircularProgress,{size:24,color:\"inherit\"}):\"Đăng Nhập\"}),/*#__PURE__*/_jsxs(Grid,{container:true,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:true,children:/*#__PURE__*/_jsx(Link,{href:\"#\",variant:\"body2\",children:\"Qu\\xEAn m\\u1EADt kh\\u1EA9u?\"})}),/*#__PURE__*/_jsx(Grid,{item:true,children:/*#__PURE__*/_jsx(Link,{href:\"/register\",variant:\"body2\",children:\"Chưa có tài khoản? Đăng ký\"})})]}),/*#__PURE__*/_jsx(Divider,{sx:{my:3},children:\"Ho\\u1EB7c\"}),/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",color:\"secondary\",startIcon:googleLoading?/*#__PURE__*/_jsx(CircularProgress,{size:20,color:\"inherit\"}):/*#__PURE__*/_jsx(Google,{}),onClick:handleGoogleLogin,disabled:googleLoading,sx:{py:1.5},children:googleLoading?\"Đang xử lý...\":\"Đăng nhập bằng Google\"})]})]})})]});};export default LoginPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}