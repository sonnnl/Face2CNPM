{"ast":null,"code":"import * as faceapi from \"face-api.js\";\nlet isModelsLoaded = false;\n\n/**\r\n * Tải các model face-api.js\r\n * @returns {Promise<boolean>}\r\n */\nexport const loadModels = async () => {\n  if (isModelsLoaded) {\n    return true;\n  }\n  try {\n    const MODEL_URL = \"/models\";\n    await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL), faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)]);\n    isModelsLoaded = true;\n    return true;\n  } catch (error) {\n    console.error(\"Error loading models:\", error);\n    throw error;\n  }\n};\n\n/**\r\n * Phát hiện khuôn mặt từ hình ảnh\r\n * @param {string} imageData - Base64 image data\r\n * @returns {Promise<Object>} - Kết quả phát hiện khuôn mặt\r\n */\nexport const detectFace = async imageData => {\n  if (!isModelsLoaded) {\n    await loadModels();\n  }\n  try {\n    const img = await faceapi.fetchImage(imageData);\n    const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();\n    return detections;\n  } catch (error) {\n    console.error(\"Error detecting face:\", error);\n    throw error;\n  }\n};\n\n/**\r\n * Phát hiện khuôn mặt real-time từ video\r\n * @param {HTMLVideoElement} videoElement - Phần tử video\r\n * @param {HTMLCanvasElement} canvasElement - Phần tử canvas để vẽ landmarks\r\n * @returns {Promise<Object>} - Kết quả phát hiện khuôn mặt\r\n */\nexport const detectFacesRealtime = async (videoElement, canvasElement) => {\n  if (!isModelsLoaded) {\n    await loadModels();\n  }\n  if (!videoElement || !canvasElement) {\n    return null;\n  }\n  const displaySize = {\n    width: videoElement.width,\n    height: videoElement.height\n  };\n\n  // Đảm bảo canvas có kích thước phù hợp với video\n  faceapi.matchDimensions(canvasElement, displaySize);\n  try {\n    // Phát hiện khuôn mặt với landmarks\n    const detections = await faceapi.detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();\n    if (detections) {\n      // Điều chỉnh kết quả theo kích thước hiển thị\n      const resizedDetections = faceapi.resizeResults(detections, displaySize);\n\n      // Xóa canvas trước khi vẽ mới\n      const ctx = canvasElement.getContext(\"2d\");\n      ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);\n\n      // Vẽ các đường viền khuôn mặt và landmarks\n      faceapi.draw.drawDetections(canvasElement, resizedDetections);\n      faceapi.draw.drawFaceLandmarks(canvasElement, resizedDetections);\n      return resizedDetections;\n    }\n    return null;\n  } catch (error) {\n    console.error(\"Error detecting face in realtime:\", error);\n    return null;\n  }\n};\n\n/**\r\n * Tính toán khoảng cách Euclid giữa các đặc trưng khuôn mặt\r\n * @param {Float32Array} descriptor1 - Đặc trưng khuôn mặt 1\r\n * @param {Float32Array} descriptor2 - Đặc trưng khuôn mặt 2\r\n * @returns {number} - Khoảng cách (0-1, càng nhỏ càng giống nhau)\r\n */\nexport const getFaceDistance = (descriptor1, descriptor2) => {\n  return faceapi.euclideanDistance(descriptor1, descriptor2);\n};\n\n/**\r\n * Kiểm tra xem khuôn mặt có phải là cùng một người không\r\n * @param {Float32Array} descriptor1 - Đặc trưng khuôn mặt 1\r\n * @param {Float32Array} descriptor2 - Đặc trưng khuôn mặt 2\r\n * @param {number} threshold - Ngưỡng để xác định là cùng một người (mặc định: 0.6)\r\n * @returns {boolean} - Có phải cùng một người không\r\n */\nexport const isSameFace = (descriptor1, descriptor2, threshold = 0.6) => {\n  const distance = getFaceDistance(descriptor1, descriptor2);\n  return distance < threshold;\n};","map":{"version":3,"names":["faceapi","isModelsLoaded","loadModels","MODEL_URL","Promise","all","nets","tinyFaceDetector","loadFromUri","faceLandmark68Net","faceRecognitionNet","error","console","detectFace","imageData","img","fetchImage","detections","detectSingleFace","TinyFaceDetectorOptions","withFaceLandmarks","withFaceDescriptor","detectFacesRealtime","videoElement","canvasElement","displaySize","width","height","matchDimensions","resizedDetections","resizeResults","ctx","getContext","clearRect","draw","drawDetections","drawFaceLandmarks","getFaceDistance","descriptor1","descriptor2","euclideanDistance","isSameFace","threshold","distance"],"sources":["C:/Users/kasiz/Documents/Studying/FaceReg/frontend/src/utils/faceUtils.js"],"sourcesContent":["import * as faceapi from \"face-api.js\";\r\n\r\nlet isModelsLoaded = false;\r\n\r\n/**\r\n * Tải các model face-api.js\r\n * @returns {Promise<boolean>}\r\n */\r\nexport const loadModels = async () => {\r\n  if (isModelsLoaded) {\r\n    return true;\r\n  }\r\n\r\n  try {\r\n    const MODEL_URL = \"/models\";\r\n    await Promise.all([\r\n      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),\r\n      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),\r\n      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),\r\n    ]);\r\n    isModelsLoaded = true;\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error loading models:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Phát hiện khuôn mặt từ hình ảnh\r\n * @param {string} imageData - Base64 image data\r\n * @returns {Promise<Object>} - Kết quả phát hiện khuôn mặt\r\n */\r\nexport const detectFace = async (imageData) => {\r\n  if (!isModelsLoaded) {\r\n    await loadModels();\r\n  }\r\n\r\n  try {\r\n    const img = await faceapi.fetchImage(imageData);\r\n    const detections = await faceapi\r\n      .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())\r\n      .withFaceLandmarks()\r\n      .withFaceDescriptor();\r\n\r\n    return detections;\r\n  } catch (error) {\r\n    console.error(\"Error detecting face:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Phát hiện khuôn mặt real-time từ video\r\n * @param {HTMLVideoElement} videoElement - Phần tử video\r\n * @param {HTMLCanvasElement} canvasElement - Phần tử canvas để vẽ landmarks\r\n * @returns {Promise<Object>} - Kết quả phát hiện khuôn mặt\r\n */\r\nexport const detectFacesRealtime = async (videoElement, canvasElement) => {\r\n  if (!isModelsLoaded) {\r\n    await loadModels();\r\n  }\r\n\r\n  if (!videoElement || !canvasElement) {\r\n    return null;\r\n  }\r\n\r\n  const displaySize = {\r\n    width: videoElement.width,\r\n    height: videoElement.height,\r\n  };\r\n\r\n  // Đảm bảo canvas có kích thước phù hợp với video\r\n  faceapi.matchDimensions(canvasElement, displaySize);\r\n\r\n  try {\r\n    // Phát hiện khuôn mặt với landmarks\r\n    const detections = await faceapi\r\n      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions())\r\n      .withFaceLandmarks();\r\n\r\n    if (detections) {\r\n      // Điều chỉnh kết quả theo kích thước hiển thị\r\n      const resizedDetections = faceapi.resizeResults(detections, displaySize);\r\n\r\n      // Xóa canvas trước khi vẽ mới\r\n      const ctx = canvasElement.getContext(\"2d\");\r\n      ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);\r\n\r\n      // Vẽ các đường viền khuôn mặt và landmarks\r\n      faceapi.draw.drawDetections(canvasElement, resizedDetections);\r\n      faceapi.draw.drawFaceLandmarks(canvasElement, resizedDetections);\r\n\r\n      return resizedDetections;\r\n    }\r\n\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Error detecting face in realtime:\", error);\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * Tính toán khoảng cách Euclid giữa các đặc trưng khuôn mặt\r\n * @param {Float32Array} descriptor1 - Đặc trưng khuôn mặt 1\r\n * @param {Float32Array} descriptor2 - Đặc trưng khuôn mặt 2\r\n * @returns {number} - Khoảng cách (0-1, càng nhỏ càng giống nhau)\r\n */\r\nexport const getFaceDistance = (descriptor1, descriptor2) => {\r\n  return faceapi.euclideanDistance(descriptor1, descriptor2);\r\n};\r\n\r\n/**\r\n * Kiểm tra xem khuôn mặt có phải là cùng một người không\r\n * @param {Float32Array} descriptor1 - Đặc trưng khuôn mặt 1\r\n * @param {Float32Array} descriptor2 - Đặc trưng khuôn mặt 2\r\n * @param {number} threshold - Ngưỡng để xác định là cùng một người (mặc định: 0.6)\r\n * @returns {boolean} - Có phải cùng một người không\r\n */\r\nexport const isSameFace = (descriptor1, descriptor2, threshold = 0.6) => {\r\n  const distance = getFaceDistance(descriptor1, descriptor2);\r\n  return distance < threshold;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}