{"ast":null,"code":"import React,{useState,useEffect}from\"react\";import{useDispatch}from\"react-redux\";import{useNavigate,useLocation}from\"react-router-dom\";import{useSnackbar}from\"notistack\";import axios from\"../utils/axios\";import{Container,Box,Typography,Button,Paper,TextField,FormControl,InputLabel,Select,MenuItem,CircularProgress,Avatar,Grid,FormHelperText,Autocomplete,Card,CardContent,CardActionArea,Alert,Divider,Chip,Accordion,AccordionSummary,AccordionDetails}from\"@mui/material\";import{School,Work,Person,Check,Info,ExpandMore,Face}from\"@mui/icons-material\";import{setCredentials}from\"../redux/slices/authSlice\";import FaceRegistrationComponent from\"../components/FaceRegistrationComponent\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||\"http://localhost:5000/api\";const CompleteRegistrationPage=()=>{const dispatch=useDispatch();const navigate=useNavigate();const location=useLocation();const{enqueueSnackbar}=useSnackbar();const[isLoading,setIsLoading]=useState(false);const[advisors,setAdvisors]=useState([]);const[departments,setDepartments]=useState([]);const[mainClasses,setMainClasses]=useState([]);const[filteredClasses,setFilteredClasses]=useState([]);const[loadingAdvisors,setLoadingAdvisors]=useState(false);const[loadingDepartments,setLoadingDepartments]=useState(false);const[loadingClasses,setLoadingClasses]=useState(false);const[showRoleSelection,setShowRoleSelection]=useState(true);const[faceRegistrationExpanded,setFaceRegistrationExpanded]=useState(false);const[faceData,setFaceData]=useState(null);const[includeFaceData,setIncludeFaceData]=useState(false);// Lấy thông tin từ URL params\nconst queryParams=new URLSearchParams(location.search);const email=queryParams.get(\"email\");const googleId=queryParams.get(\"googleId\");const name=queryParams.get(\"name\");const avatar=queryParams.get(\"avatar\");const needsRegistration=queryParams.get(\"needsRegistration\")===\"true\";const[formData,setFormData]=useState({role:\"\",fullName:name||\"\",phone:\"\",department:\"\",studentId:\"\",studentCode:\"\",teacherCode:\"\",major:\"\",class:\"\",year:new Date().getFullYear(),advisorId:\"\"});const[formErrors,setFormErrors]=useState({role:\"\",fullName:\"\",advisorId:\"\",department:\"\",class:\"\"});useEffect(()=>{// Kiểm tra xem có đủ thông tin không\nif(!email||!googleId){enqueueSnackbar(\"Thiếu thông tin cần thiết để hoàn tất đăng ký\",{variant:\"error\"});navigate(\"/login\",{replace:true});}// Bỏ thông báo cho người dùng mới\n// if (needsRegistration) {\n//   enqueueSnackbar(\"Vui lòng hoàn tất thông tin đăng ký của bạn\", {\n//     variant: \"info\",\n//     autoHideDuration: 5000,\n//   });\n// }\n},[email,googleId,navigate,enqueueSnackbar]);// Tải dữ liệu khoa và lớp khi trang được hiển thị\nuseEffect(()=>{fetchDepartments();fetchMainClasses();},[]);// Lấy danh sách giáo viên cố vấn khi người dùng chọn vai trò sinh viên\nuseEffect(()=>{if(formData.role===\"student\"){fetchAdvisors();}},[formData.role]);// Lọc danh sách lớp theo khoa được chọn\nuseEffect(()=>{if(formData.department&&mainClasses.length>0){const filtered=mainClasses.filter(cls=>cls.department_id&&cls.department_id._id===formData.department);setFilteredClasses(filtered);// Log để kiểm tra\nconsole.log(\"Department ID:\",formData.department);console.log(\"Main Classes:\",mainClasses);console.log(\"Filtered Classes:\",filtered);}else{setFilteredClasses([]);}},[formData.department,mainClasses]);const fetchAdvisors=async()=>{setLoadingAdvisors(true);try{const response=await axios.get(`${API_URL}/users/teachers/public`);if(response.data.success){setAdvisors(response.data.data);}}catch(error){console.error(\"Error fetching advisors:\",error);setAdvisors([]);enqueueSnackbar(\"Không thể tải danh sách giáo viên cố vấn\",{variant:\"error\"});}finally{setLoadingAdvisors(false);}};const fetchDepartments=async()=>{setLoadingDepartments(true);try{const response=await axios.get(`${API_URL}/departments/public`);if(response.data.success){setDepartments(response.data.data);}}catch(error){console.error(\"Error fetching departments:\",error);setDepartments([]);enqueueSnackbar(\"Không thể tải danh sách khoa\",{variant:\"error\"});}finally{setLoadingDepartments(false);}};const fetchMainClasses=async()=>{setLoadingClasses(true);try{const response=await axios.get(`${API_URL}/classes/main/public?all=true`);if(response.data.success){setMainClasses(response.data.data);}}catch(error){console.error(\"Error fetching main classes:\",error);setMainClasses([]);enqueueSnackbar(\"Không thể tải danh sách lớp\",{variant:\"error\"});}finally{setLoadingClasses(false);}};const handleChange=e=>{const{name,value}=e.target;setFormData({...formData,[name]:value});// Xóa lỗi khi người dùng nhập\nif(formErrors[name]){setFormErrors({...formErrors,[name]:\"\"});}};const handleAdvisorChange=(event,newValue)=>{setFormData({...formData,advisorId:(newValue===null||newValue===void 0?void 0:newValue._id)||\"\"});if(formErrors.advisorId){setFormErrors({...formErrors,advisorId:\"\"});}};const handleRoleSelect=role=>{setFormData({...formData,role});setFormErrors({...formErrors,role:\"\"});// Bỏ bước trung gian, chuyển thẳng đến form đăng ký\nsetShowRoleSelection(false);};const validateForm=()=>{let valid=true;const errors={...formErrors};// Kiểm tra vai trò\nif(!formData.role){errors.role=\"Vui lòng chọn vai trò\";valid=false;}// Kiểm tra họ tên\nif(!formData.fullName){errors.fullName=\"Họ tên là bắt buộc\";valid=false;}// Kiểm tra giáo viên cố vấn cho sinh viên\nif(formData.role===\"student\"&&!formData.advisorId){errors.advisorId=\"Vui lòng chọn giáo viên cố vấn\";valid=false;}// Kiểm tra khoa\nif(formData.role===\"student\"&&!formData.department){errors.department=\"Vui lòng chọn khoa\";valid=false;}setFormErrors(errors);return valid;};const handleFaceDataCapture=capturedFaceData=>{setFaceData(capturedFaceData);setIncludeFaceData(true);};const handleSubmit=async e=>{e.preventDefault();if(!validateForm()){return;}setIsLoading(true);try{// Chuẩn bị dữ liệu\nconst registrationData={email,googleId,fullName:formData.fullName,role:formData.role,avatarUrl:avatar};// Thêm thông tin cố vấn cho sinh viên\nif(formData.role===\"student\"&&formData.advisorId){registrationData.advisor_id=formData.advisorId;}// Tìm thông tin khoa được chọn\nconst selectedDepartment=departments.find(dept=>dept._id===formData.department);// Tìm thông tin lớp được chọn\nconst selectedClass=mainClasses.find(cls=>cls._id===formData.class);// Thêm thông tin trường học\nregistrationData.school_info={department:selectedDepartment?selectedDepartment.name:formData.department,department_id:formData.department,major:formData.major,class:selectedClass?selectedClass.name:formData.class,class_id:formData.class,year:formData.year};// Thêm mã sinh viên/giáo viên\nif(formData.role===\"student\"){if(formData.studentId){registrationData.school_info.student_id=formData.studentId;}if(formData.studentCode){registrationData.school_info.student_code=formData.studentCode;}}else if(formData.role===\"teacher\"&&formData.teacherCode){registrationData.school_info.teacher_code=formData.teacherCode;}// Thêm số điện thoại\nif(formData.phone){registrationData.contact={phone:formData.phone};}// Thêm dữ liệu khuôn mặt nếu có\nif(includeFaceData&&faceData){registrationData.faceFeatures={descriptors:faceData.map(data=>data.descriptor),lastUpdated:new Date()};}const response=await axios.post(`${API_URL}/auth/google-complete`,registrationData);if(response.data.success){dispatch(setCredentials({token:response.data.token,user:response.data.user}));enqueueSnackbar(response.data.message||\"Đăng ký thành công!\",{variant:\"success\"});// Chuyển hướng đến trang chờ phê duyệt\nnavigate(`/pending-approval?role=${formData.role}`);}}catch(error){var _error$response,_error$response$data;const errorMessage=((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.message)||\"Đăng ký thất bại\";enqueueSnackbar(errorMessage,{variant:\"error\"});}finally{setIsLoading(false);}};// Hiển thị trang chọn vai trò\nconst renderRoleSelection=()=>{return/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"B\\u1EA1n l\\xE0 ai trong h\\u1EC7 th\\u1ED1ng?\"}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:3,sx:{mt:1},children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(Card,{variant:\"outlined\",sx:{height:\"100%\",borderColor:formData.role===\"student\"?\"primary.main\":\"grey.300\",boxShadow:formData.role===\"student\"?3:1},children:/*#__PURE__*/_jsx(CardActionArea,{onClick:()=>handleRoleSelect(\"student\"),sx:{height:\"100%\",p:2},children:/*#__PURE__*/_jsxs(CardContent,{sx:{textAlign:\"center\"},children:[/*#__PURE__*/_jsx(School,{color:\"primary\",sx:{fontSize:60,mb:2}}),/*#__PURE__*/_jsx(Typography,{variant:\"h5\",component:\"div\",gutterBottom:true,children:\"Sinh Vi\\xEAn\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:\"\\u0110\\u0103ng k\\xFD v\\u1EDBi t\\u01B0 c\\xE1ch sinh vi\\xEAn v\\xE0 ch\\u1ECDn gi\\xE1o vi\\xEAn c\\u1ED1 v\\u1EA5n c\\u1EE7a b\\u1EA1n.\"}),formData.role===\"student\"&&/*#__PURE__*/_jsx(Check,{sx:{position:\"absolute\",right:16,top:16,color:\"primary.main\",backgroundColor:\"white\",borderRadius:\"50%\"}})]})})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(Card,{variant:\"outlined\",sx:{height:\"100%\",borderColor:formData.role===\"teacher\"?\"primary.main\":\"grey.300\",boxShadow:formData.role===\"teacher\"?3:1},children:/*#__PURE__*/_jsx(CardActionArea,{onClick:()=>handleRoleSelect(\"teacher\"),sx:{height:\"100%\",p:2},children:/*#__PURE__*/_jsxs(CardContent,{sx:{textAlign:\"center\"},children:[/*#__PURE__*/_jsx(Work,{color:\"secondary\",sx:{fontSize:60,mb:2}}),/*#__PURE__*/_jsx(Typography,{variant:\"h5\",component:\"div\",gutterBottom:true,children:\"Gi\\u1EA3ng Vi\\xEAn\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:\"\\u0110\\u0103ng k\\xFD v\\u1EDBi t\\u01B0 c\\xE1ch gi\\u1EA3ng vi\\xEAn \\u0111\\u1EC3 qu\\u1EA3n l\\xFD l\\u1EDBp h\\u1ECDc v\\xE0 sinh vi\\xEAn.\"}),formData.role===\"teacher\"&&/*#__PURE__*/_jsx(Check,{sx:{position:\"absolute\",right:16,top:16,color:\"primary.main\",backgroundColor:\"white\",borderRadius:\"50%\"}})]})})})})]})]});};// Hiển thị form nhập thông tin\nconst renderRegistrationForm=()=>{return/*#__PURE__*/_jsxs(Box,{component:\"form\",onSubmit:handleSubmit,noValidate:true,children:[/*#__PURE__*/_jsx(Box,{sx:{mb:3},children:/*#__PURE__*/_jsx(Divider,{children:/*#__PURE__*/_jsx(Chip,{icon:formData.role===\"student\"?/*#__PURE__*/_jsx(School,{}):/*#__PURE__*/_jsx(Work,{}),label:formData.role===\"student\"?\"Sinh viên\":\"Giảng viên\",color:\"primary\"})})}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsx(TextField,{required:true,fullWidth:true,id:\"fullName\",label:\"H\\u1ECD v\\xE0 t\\xEAn\",name:\"fullName\",value:formData.fullName,onChange:handleChange,error:!!formErrors.fullName,helperText:formErrors.fullName})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"phone\",label:\"S\\u1ED1 \\u0111i\\u1EC7n tho\\u1EA1i\",name:\"phone\",value:formData.phone,onChange:handleChange})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,required:true,error:!!formErrors.department,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"department-label\",children:\"Khoa\"}),/*#__PURE__*/_jsx(Select,{labelId:\"department-label\",id:\"department\",name:\"department\",value:formData.department,label:\"Khoa\",onChange:handleChange,disabled:loadingDepartments,children:departments.map(dept=>/*#__PURE__*/_jsx(MenuItem,{value:dept._id,children:dept.name},dept._id))}),formErrors.department&&/*#__PURE__*/_jsx(FormHelperText,{children:formErrors.department}),loadingDepartments&&/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\",mt:1},children:[/*#__PURE__*/_jsx(CircularProgress,{size:20,sx:{mr:1}}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",children:\"\\u0110ang t\\u1EA3i danh s\\xE1ch khoa...\"})]})]})}),formData.role===\"student\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"studentId\",label:\"M\\xE3 s\\u1ED1 sinh vi\\xEAn (MSSV)\",name:\"studentId\",value:formData.studentId,onChange:handleChange})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"studentCode\",label:\"M\\xE3 sinh vi\\xEAn (M\\xE3 c\\u0169)\",name:\"studentCode\",value:formData.studentCode,onChange:handleChange})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"major\",label:\"Ng\\xE0nh h\\u1ECDc\",name:\"major\",value:formData.major,onChange:handleChange})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,required:true,error:!!formErrors.class,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"class-label\",children:\"L\\u1EDBp\"}),/*#__PURE__*/_jsx(Select,{labelId:\"class-label\",id:\"class\",name:\"class\",value:formData.class,label:\"L\\u1EDBp\",onChange:handleChange,disabled:!formData.department||loadingClasses,children:filteredClasses.length>0?filteredClasses.map(cls=>/*#__PURE__*/_jsxs(MenuItem,{value:cls._id,children:[cls.name,\" (\",cls.class_code,\")\"]},cls._id)):/*#__PURE__*/_jsx(MenuItem,{disabled:true,value:\"\",children:formData.department?\"Không có lớp nào trong khoa này\":\"Vui lòng chọn khoa trước\"})}),formErrors.class&&/*#__PURE__*/_jsx(FormHelperText,{children:formErrors.class}),loadingClasses&&/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\",mt:1},children:[/*#__PURE__*/_jsx(CircularProgress,{size:20,sx:{mr:1}}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",children:\"\\u0110ang t\\u1EA3i danh s\\xE1ch l\\u1EDBp...\"})]})]})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"year\",label:\"Kh\\xF3a h\\u1ECDc\",name:\"year\",type:\"number\",value:formData.year,onChange:handleChange})}),/*#__PURE__*/_jsxs(Grid,{item:true,xs:12,children:[/*#__PURE__*/_jsx(Autocomplete,{id:\"advisorId\",options:advisors,getOptionLabel:option=>`${option.full_name} (${option.email})`,loading:loadingAdvisors,onChange:handleAdvisorChange,renderInput:params=>/*#__PURE__*/_jsx(TextField,{...params,required:true,label:\"Gi\\xE1o vi\\xEAn c\\u1ED1 v\\u1EA5n\",error:!!formErrors.advisorId,helperText:formErrors.advisorId||\"Vui lòng chọn giáo viên cố vấn của bạn\",InputProps:{...params.InputProps,endAdornment:/*#__PURE__*/_jsxs(_Fragment,{children:[loadingAdvisors?/*#__PURE__*/_jsx(CircularProgress,{color:\"inherit\",size:20}):null,params.InputProps.endAdornment]})}})}),advisors.length===0&&!loadingAdvisors&&/*#__PURE__*/_jsx(Alert,{severity:\"warning\",sx:{mt:1},children:\"Kh\\xF4ng c\\xF3 gi\\xE1o vi\\xEAn n\\xE0o \\u0111\\u01B0\\u1EE3c t\\xECm th\\u1EA5y. Vui l\\xF2ng li\\xEAn h\\u1EC7 v\\u1EDBi qu\\u1EA3n tr\\u1ECB vi\\xEAn.\"})]})]}),formData.role===\"teacher\"&&/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:6,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,id:\"teacherCode\",label:\"M\\xE3 gi\\u1EA3ng vi\\xEAn\",name:\"teacherCode\",value:formData.teacherCode,onChange:handleChange})})]}),formData.role===\"student\"&&/*#__PURE__*/_jsxs(Accordion,{expanded:faceRegistrationExpanded,onChange:()=>setFaceRegistrationExpanded(!faceRegistrationExpanded),sx:{mt:3},children:[/*#__PURE__*/_jsx(AccordionSummary,{expandIcon:/*#__PURE__*/_jsx(ExpandMore,{}),children:/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\"},children:[/*#__PURE__*/_jsx(Face,{sx:{mr:1}}),/*#__PURE__*/_jsx(Typography,{children:\"\\u0110\\u0103ng k\\xFD khu\\xF4n m\\u1EB7t (t\\xF9y ch\\u1ECDn)\"}),faceData&&includeFaceData&&/*#__PURE__*/_jsx(Chip,{label:\"\\u0110\\xE3 \\u0111\\u0103ng k\\xFD\",color:\"success\",size:\"small\",sx:{ml:2},icon:/*#__PURE__*/_jsx(Check,{fontSize:\"small\"})})]})}),/*#__PURE__*/_jsxs(AccordionDetails,{children:[/*#__PURE__*/_jsx(Alert,{severity:\"info\",sx:{mb:2},children:\"\\u0110\\u0103ng k\\xFD khu\\xF4n m\\u1EB7t s\\u1EBD gi\\xFAp gi\\u1EA3ng vi\\xEAn x\\xE1c nh\\u1EADn danh t\\xEDnh v\\xE0 s\\u1EED d\\u1EE5ng cho \\u0111i\\u1EC3m danh t\\u1EF1 \\u0111\\u1ED9ng\"}),/*#__PURE__*/_jsx(FaceRegistrationComponent,{onFaceDataCapture:handleFaceDataCapture}),/*#__PURE__*/_jsx(Box,{sx:{mt:2,display:\"flex\",alignItems:\"center\"},children:/*#__PURE__*/_jsx(FormControl,{sx:{flexGrow:1},children:/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:includeFaceData?\"success\":\"primary\",onClick:()=>setIncludeFaceData(!includeFaceData),disabled:!faceData,startIcon:includeFaceData?/*#__PURE__*/_jsx(Check,{}):null,children:includeFaceData?\"Đã xác nhận sử dụng dữ liệu khuôn mặt\":\"Không sử dụng dữ liệu khuôn mặt\"})})})]})]}),/*#__PURE__*/_jsxs(Box,{sx:{mt:3,display:\"flex\",justifyContent:\"space-between\"},children:[/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:()=>setShowRoleSelection(true),children:\"Quay l\\u1EA1i\"}),/*#__PURE__*/_jsx(Button,{type:\"submit\",variant:\"contained\",disabled:isLoading,children:isLoading?/*#__PURE__*/_jsx(CircularProgress,{size:24,color:\"inherit\"}):\"Hoàn tất đăng ký\"})]})]});};return/*#__PURE__*/_jsx(Container,{component:\"main\",maxWidth:\"md\",children:/*#__PURE__*/_jsx(Box,{sx:{marginTop:4,marginBottom:4,display:\"flex\",flexDirection:\"column\",alignItems:\"center\"},children:/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{padding:4,width:\"100%\",borderRadius:3},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",alignItems:\"center\",mb:4,flexDirection:\"column\"},children:[/*#__PURE__*/_jsx(Typography,{component:\"h1\",variant:\"h4\",gutterBottom:true,children:showRoleSelection?\"Chọn vai trò của bạn\":\"Hoàn tất đăng ký\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",color:\"text.secondary\",mb:2,children:showRoleSelection?\"Vui lòng chọn vai trò để tiếp tục quá trình đăng ký\":\"Vui lòng cung cấp thêm thông tin để hoàn tất đăng ký\"}),avatar&&/*#__PURE__*/_jsx(Avatar,{src:avatar,alt:name||email,sx:{width:80,height:80,mb:2}}),/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",gutterBottom:true,children:email})]}),showRoleSelection?renderRoleSelection():renderRegistrationForm()]})})});};export default CompleteRegistrationPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}